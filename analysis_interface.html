<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalentScope - Analyse des CVs</title>
    <link rel="icon" type="image/png" href="Logos/TalentScope.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
display: flex;
            padding-top: 70px; /* Espace pour la barre de progression fixe en haut */
        }

        /* Animations */
        @keyframes fadeInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        /* Barre de progression fixe */
        .progress-bar-fixed {
            position: fixed;
            top: 0;
            left: 280px; /* Commencer après la sidebar */
            right: 0;
            background: transparent; /* Supprimer le fond blanc */
            padding: 10px 20px; /* Réduire le padding */
            z-index: 1000;
            animation: slideInDown 0.5s ease-out;
            height: 60px; /* Hauteur fixe réduite */
        }

        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .progress-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            gap: 15px;
            height: 100%;
        }

        .progress-steps {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 10px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: default;
            position: relative;
        }

        .progress-step.completed {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .progress-step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transform: scale(1.05);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite, glow 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1.05); }
        }

        @keyframes glow {
            0% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(102, 126, 234, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        }

        .progress-step.pending {
            background: rgba(156, 163, 175, 0.1);
            color: #9ca3af;
        }

        .step-number {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .step-number i {
            font-size: 0.6rem;
        }

        .progress-step.completed .step-number {
            background: #16a34a;
            color: white;
        }

        .progress-step.active .step-number {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .progress-step.pending .step-number {
            background: #e5e7eb;
            color: #9ca3af;
        }

        .step-title {
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .progress-line {
            height: 2px;
            background: #e5e7eb;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .progress-line.completed {
            background: #16a34a;
        }

        .progress-line.active {
            background: linear-gradient(90deg, #16a34a 0%, #667eea 100%);
        }

        .navigation-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
            justify-content: center;
        }

        .nav-btn.prev {
            background: rgba(156, 163, 175, 0.1);
            color: #6b7280;
            border: 2px solid rgba(156, 163, 175, 0.2);
        }

        .nav-btn.prev:hover:not(:disabled) {
            background: rgba(156, 163, 175, 0.2);
            transform: translateY(-2px);
        }

        .nav-btn.next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: 2px solid transparent;
        }

        .nav-btn.next:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            animation: buttonPulse 0.3s ease;
        }

        @keyframes buttonPulse {
            0% { transform: translateY(-2px) scale(1); }
            50% { transform: translateY(-2px) scale(1.05); }
            100% { transform: translateY(-2px) scale(1); }
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Responsive pour la barre de progression */
        @media (max-width: 768px) {
            .progress-bar-fixed {
                left: 0;
                right: 0;
            }
            
            .progress-container {
                flex-direction: column;
                gap: 10px;
            }

            .progress-steps {
                order: 2;
                width: 100%;
                justify-content: center;
            }

            .navigation-buttons {
                order: 1;
                width: 100%;
                justify-content: center;
            }

            .step-title {
                display: none;
            }

            .progress-step {
                padding: 6px 8px;
            }

            .nav-btn {
                min-width: 100px;
                padding: 8px 16px;
            }
        }

/* Sidebar */
.sidebar {
width: 280px;
background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 0 25px 25px 0;
            padding: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
border: 1px solid rgba(255, 255, 255, 0.3);
position: fixed;
            height: calc(100vh - 20px); /* Réduire la hauteur */
            top: 10px; /* Déplacer vers le haut */
            overflow-y: auto;
display: flex;
flex-direction: column;
justify-content: space-between;
            animation: slideIn 0.8s ease-out;
}

.logo {
text-align: center;
margin-bottom: 40px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .logo img {
            max-width: 60px;
            height: auto;
            margin-bottom: 15px;
            animation: pulse 2s ease-in-out infinite;
        }

.logo h1 {
background: linear-gradient(135deg, #667eea, #764ba2);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
            font-size: 1.8rem;
font-weight: 700;
margin-bottom: 8px;
}

.logo p {
color: #666;
font-size: 0.9rem;
}

.nav-section {
flex: 1;
display: flex;
flex-direction: column;
}

.nav-title {
color: #333;
font-size: 0.9rem;
font-weight: 600;
text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            padding: 0 10px;
}

.nav-item {
display: flex;
align-items: center;
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 15px;
cursor: pointer;
transition: all 0.3s ease;
color: #666;
text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

.nav-item:hover {
background: rgba(102, 126, 234, 0.1);
color: #667eea;
transform: translateX(5px);
}



.nav-item.active {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}

.nav-item i {
            margin-right: 15px;
font-size: 1.2rem;
width: 20px;
}

.nav-item span {
font-weight: 500;
}

.nav-item .subtitle {
font-size: 0.8rem;
opacity: 0.8;
margin-top: 2px;
}

/* Main Content */
.main-content {
flex: 1;
margin-left: 280px;
            padding: 10px;
overflow-y: auto;
            max-height: calc(100vh - 80px); /* Ajuster pour la barre fixe réduite */
            background: transparent; /* Supprimer le fond blanc */
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
font-weight: 700;
margin-bottom: 8px;
}

        .header p {
            color: #666;
            font-size: 1rem;
            margin: 0;
        }

/* Progress Bar */
.progress-container {
background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
margin-bottom: 30px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.8s ease-out 0.6s both;
}

.progress-steps {
display: flex;
justify-content: space-between;
align-items: center;
            position: relative;
margin-bottom: 20px;
}

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 2px;
            z-index: 1;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            z-index: 2;
            transition: width 0.5s ease;
        }

.step {
display: flex;
flex-direction: column;
align-items: center;
position: relative;
            z-index: 3;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step:hover {
            transform: translateY(-5px);
        }

.step-circle {
            width: 50px;
            height: 50px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-weight: 600;
            margin-bottom: 10px;
transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .step-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .step:hover .step-circle::before {
            left: 100%;
        }

        .step.completed .step-circle {
            background: linear-gradient(135deg, #22c55e, #16a34a);
color: white;
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);
}

        .step.active .step-circle {
            background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        .step.pending .step-circle {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

.step-label {
font-size: 0.9rem;
font-weight: 500;
            color: #333;
text-align: center;
}

        .step.completed .step-label {
            color: #22c55e;
        }

.step.active .step-label {
color: #667eea;
        }


.step-content {
            display: none;
background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 15px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

.step-content.active {
display: block;
            opacity: 1;
            transform: translateY(0);
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
            animation: fadeInUp 0.5s ease-out;
        }

.form-group {
            margin-bottom: 15px;
}

        .form-group label {
display: block;
margin-bottom: 8px;
            color: #333;
            font-weight: 600;
font-size: 1rem;
}

        .form-group input,
        .form-group select,
        .form-group textarea {
width: 100%;
padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
border-radius: 12px;
font-size: 1rem;
transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
}

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
outline: none;
border-color: #667eea;
box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
}

        .form-group textarea {
            min-height: 60px;
resize: vertical;
}

        .skills-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .skill-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeInUp 0.3s ease-out;
        }

        .skill-tag .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .skill-tag .remove:hover {
            opacity: 1;
        }

.file-upload-area {
            border: 3px dashed rgba(102, 126, 234, 0.3);
            border-radius: 15px;
padding: 40px;
text-align: center;
cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
}

.file-upload-area:hover {
border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-5px);
}

.file-upload-area.dragover {
border-color: #667eea;
background: rgba(102, 126, 234, 0.1);
transform: scale(1.02);
}

        .upload-icon {
font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        .uploaded-files {
margin-top: 20px;
}

.file-item {
display: flex;
align-items: center;
            justify-content: space-between;
padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
margin-bottom: 10px;
            animation: fadeInUp 0.3s ease-out;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

.file-icon {
font-size: 1.5rem;
color: #667eea;
}

        .file-details h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .file-details p {
            color: #666;
font-size: 0.9rem;
}

.file-actions {
display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
border: none;
            border-radius: 10px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
align-items: center;
gap: 8px;
}

.btn-primary {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
}

.btn-primary:hover {
transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

.btn-secondary:hover {
            background: rgba(102, 126, 234, 0.2);
transform: translateY(-2px);
}

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }

.btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
color: white;
}

.btn-success:hover {
transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);
        }

        /* Anciens boutons de navigation supprimés - maintenant gérés par la barre fixe */

        .loading {
            display: none;
            text-align: center;
            padding: 50px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .spinner {
            border: 6px solid rgba(0, 255, 136, 0.2);
            border-top: 6px solid #00ff88;
border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading h3 {
            color: #333;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .loading p {
            color: #555;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 20px;
            line-height: 1.5;
        }

/* Results */
.results-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
            margin-top: 20px;
}

.result-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
padding: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            animation: fadeInUp 0.5s ease-out;
        }

        .result-card h3 {
            color: #333;
            margin-bottom: 15px;
display: flex;
align-items: center;
            gap: 10px;
}

        .score {
font-size: 2rem;
font-weight: 700;
color: #667eea;
        }

        .score-excellent { color: #22c55e; }
        .score-good { color: #3b82f6; }
        .score-average { color: #f59e0b; }
        .score-poor { color: #ef4444; }

/* Responsive */
@media (max-width: 768px) {
.sidebar {
width: 100%;
height: auto;
                position: relative;
border-radius: 0;
}

.main-content {
margin-left: 0;
padding: 20px;
}

            .progress-steps {
                flex-direction: column;
                gap: 20px;
            }

            .progress-steps::before {
                display: none;
            }

            .progress-line {
                display: none;
            }
        }

        /* Styles pour la page de pondérations */
        .criteria-container {
display: flex;
flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .criteria-item {
            display: flex;
            justify-content: space-between;
align-items: center;
            background: rgba(102, 126, 234, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .criteria-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .criteria-info h3 {
            color: #667eea;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
display: flex;
align-items: center;
            gap: 8px;
}

        .criteria-info p {
            color: #666;
font-size: 0.9rem;
            margin: 0;
        }

        .criteria-weight {
display: flex;
align-items: center;
            gap: 15px;
        }

        .weight-slider {
            width: 150px;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .weight-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
border: none;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .weight-value {
font-weight: 600;
            color: #667eea;
            font-size: 1rem;
            min-width: 40px;
text-align: center;
}

        .total-weight {
            background: rgba(34, 197, 94, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(34, 197, 94, 0.2);
            text-align: center;
        }

        .total-weight h3 {
            color: #16a34a;
            margin-bottom: 5px;
        }

        .total-weight span {
            color: #16a34a;
            font-weight: 700;
        }

        /* Styles pour le classement des résultats */
        .result-card {
            position: relative;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .rank-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }

        .rank-2 {
            background: linear-gradient(135deg, #c0c0c0, #e5e5e5);
            color: #333;
        }

        .rank-3 {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            color: white;
        }

        .score-breakdown {
            margin: 15px 0;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
        }

        .score-item {
display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .score-item:last-child {
            margin-bottom: 0;
        }

        .score-item .label {
            color: #666;
            font-weight: 500;
        }

        .score-item .value {
            color: #667eea;
font-weight: 600;
        }

        .cv-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .cv-details p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #666;
        }

        .score-average {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
        }

        /* Styles pour la liste des CVs */
        .cv-list-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .cv-header {
display: flex;
align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .cv-info {
            flex: 1;
            margin-left: 15px;
        }

        .cv-info h3 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.2rem;
        }

        .cv-file {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .cv-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .view-cv-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 20px;
transition: all 0.3s ease;
}

        .view-cv-btn:hover {
transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .cv-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .cv-summary p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #666;
        }

        /* Styles pour la modal de CV */
        .cv-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
display: flex;
align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .cv-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90%;
            overflow: hidden;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .cv-modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }

        .candidate-info {
            flex: 1;
        }

        .candidate-file {
            margin: 5px 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .candidate-score {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .score-badge, .rank-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .cv-content {
            padding: 20px;
        }

        .cv-animation-container {
            position: relative;
            min-height: 400px;
        }

        .cv-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #667eea;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .cv-preview {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cv-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
            border-radius: 15px;
        }

        .candidate-photo {
            margin-right: 20px;
        }

        .candidate-photo i {
            font-size: 4rem;
            color: #667eea;
        }

        .candidate-details h3 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.5rem;
        }

        .candidate-title {
            margin: 0;
            color: #666;
            font-size: 1rem;
        }

        .cv-sections {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .cv-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .cv-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cv-section h4 i {
            color: #667eea;
        }

        .score-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .score-indicator .score {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 1s ease-out;
        }

        .formation-list, .experience-list, .languages-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .formation-list li, .experience-list li, .languages-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
        }

        .formation-list li:last-child, .experience-list li:last-child, .languages-list li:last-child {
            border-bottom: none;
        }

        .skills-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-tag {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .cv-recommendations {
            background: linear-gradient(135deg, #fff5f5, #ffe8e8);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #f59e0b;
        }

        .cv-recommendations h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cv-recommendations h4 i {
            color: #f59e0b;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recommendation-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            color: #555;
            font-size: 0.95rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        /* Styles pour le CV document */
        .cv-viewer .modal-content {
            max-width: 900px;
            width: 95%;
        }

        .cv-document {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .cv-page {
            padding: 40px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .cv-header-doc {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }

        .candidate-photo-doc {
            margin-right: 30px;
        }

        .candidate-photo-doc i {
            font-size: 5rem;
            color: #667eea;
        }

        .candidate-info-doc h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            color: #333;
            font-weight: 300;
        }

        .candidate-title-doc {
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 500;
        }

        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .contact-info p {
            margin: 0;
            font-size: 0.95rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contact-info i {
            color: #667eea;
            width: 16px;
        }

        .cv-section-doc {
            margin-bottom: 30px;
        }

        .cv-section-doc h2 {
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .cv-section-doc h2 i {
            color: #667eea;
        }

        .formation-item, .experience-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .formation-item h3, .experience-item h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            color: #333;
            font-weight: 600;
        }

        .institution, .company {
            margin: 0 0 5px 0;
            font-size: 1rem;
            color: #667eea;
            font-weight: 500;
        }

        .period {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: #888;
            font-style: italic;
        }

        .description {
            margin: 0;
            font-size: 0.95rem;
            color: #555;
        }

        .achievements {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }

        .achievements li {
            margin-bottom: 5px;
            color: #555;
        }

        .skills-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .skill-category h4 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #333;
            font-weight: 600;
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-tag {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .languages-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .language-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9ff;
            border-radius: 6px;
        }

        .language {
            font-weight: 600;
            color: #333;
        }

        .level {
            color: #667eea;
            font-weight: 500;
        }

        .cv-placeholder {
            padding: 40px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .cv-placeholder i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .cv-placeholder h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .cv-placeholder p {
            color: #666;
            margin-bottom: 20px;
        }

        /* Styles pour les recommandations */
        .recommendations {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .recommendations h4 {
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .recommendation-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .recommendation-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .recommendation-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        /* Styles pour l'analyse progressive */
        .analysis-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4aa, #00b4db);
            border-radius: 4px;
            width: 0%;
            transition: width 1s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <!-- Barre de progression fixe en haut -->
    <div class="progress-bar-fixed">
        <div class="progress-container">
            <!-- Étapes de progression -->
            <div class="progress-steps">
                <div class="progress-step" data-step="1">
                    <div class="step-number"><i class="fas fa-briefcase"></i></div>
                    <div class="step-title">Détails</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="2">
                    <div class="step-number"><i class="fas fa-upload"></i></div>
                    <div class="step-title">Import</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="3">
                    <div class="step-number"><i class="fas fa-balance-scale"></i></div>
                    <div class="step-title">Pondérations</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="4">
                    <div class="step-number"><i class="fas fa-check"></i></div>
                    <div class="step-title">Vérification</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="5">
                    <div class="step-number"><i class="fas fa-chart-line"></i></div>
                    <div class="step-title">Résultats</div>
                </div>
    </div>
    
            <!-- Boutons de navigation -->
            <div class="navigation-buttons">
                <button class="nav-btn prev" id="prevBtn" onclick="previousStep()" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Précédent
                </button>
                <button class="nav-btn next" id="nextBtn" onclick="nextStep()">
                    Suivant
                    <i class="fas fa-chevron-right"></i>
                </button>
    </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <img src="Logos/TalentScope.png" alt="TalentScope">
            <h1>TalentScope</h1>
            <p>Ministère de l'Économie et des Finances</p>
        </div>

        <div class="nav-section">
            <div class="nav-title">Navigation</div>
            
            <a href="/dashboard" class="nav-item">
                <i class="fas fa-home"></i>
                <div>
                    <span>Accueil</span>
                    <div class="subtitle">Page principale</div>
                </div>
            </a>
            
            <a href="/dashboard" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <div>
                    <span>Tableau de Bord</span>
                    <div class="subtitle">Vue d'ensemble</div>
                </div>
            </a>
            
            <a href="/analysis" class="nav-item active">
                <i class="fas fa-rocket"></i>
                <div>
                    <span>Nouvelle Analyse</span>
                    <div class="subtitle">Analyser des CVs</div>
                </div>
            </a>
            
            <a href="/processed" class="nav-item">
                <i class="fas fa-folder"></i>
                <div>
                    <span>CVs Traités</span>
                    <div class="subtitle">Historique des analyses</div>
                </div>
            </a>
            
            <a href="/settings" class="nav-item">
                <i class="fas fa-cog"></i>
                <div>
                    <span>Configuration</span>
                    <div class="subtitle">Paramètres</div>
                </div>
            </a>
        </div>



        <!-- Profil utilisateur -->
        <div class="nav-item">
            <i class="fas fa-user"></i>
            <div>
                <span id="userName">Chargement...</span>
                <div class="subtitle" id="userRole">Ministère des Finances</div>
                </div>
                </div>
                        </div>

    <!-- Main Content -->
    <div class="main-content">


        <!-- Étape 1: Détails de l'offre -->
        <div class="step-content active" id="step1">
                <h2><i class="fas fa-briefcase"></i> Détails de l'offre d'emploi</h2>
                <p style="color: #666; margin-bottom: 30px;">Remplissez les informations de l'offre d'emploi pour commencer l'analyse</p>
                
                <div class="form-group">
                    <label for="jobTitle">Titre du poste</label>
                    <input type="text" id="jobTitle" placeholder="ex: Data Scientist" value="">
                        </div>
                
                <div class="form-group">
                    <label for="department">Département</label>
                    <select id="department">
                        <option value="">Sélectionnez un département</option>
                        <option value="informatique">Informatique</option>
                        <option value="rh">Ressources Humaines</option>
                        <option value="finance">Finance</option>
                        <option value="marketing">Marketing</option>
                    </select>
                        </div>
                
                <div class="form-group">
                    <label for="jobDescription">Description du poste</label>
                    <textarea id="jobDescription" placeholder="Décrivez les responsabilités et les attentes du poste..."></textarea>
                        </div>
                
                <div class="form-group">
                    <label for="requiredSkills">Compétences requises</label>
                    <input type="text" id="skillInput" placeholder="Ajoutez des compétences et appuyez sur Entrée" value="">
                    <div class="skills-container" id="skillsContainer">
                        <!-- Les compétences ajoutées apparaîtront ici -->
                    </div>
            </div>
                
                <div class="form-group">
                    <label for="requiredExperience">Expérience requise</label>
                    <select id="requiredExperience">
                        <option value="0-2">0-2 ans (Junior)</option>
                        <option value="2-5">2-5 ans (Intermédiaire)</option>
                        <option value="5-10">5-10 ans (Senior)</option>
                        <option value="10+">10+ ans (Expert)</option>
                    </select>
        </div>
            </div>

            <!-- Étape 2: Import des CVs -->
            <div class="step-content" id="step2">
                <h2><i class="fas fa-upload"></i> Import des CVs</h2>
                <p style="color: #666; margin-bottom: 30px;">Importez les CVs des candidats à analyser</p>
                
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>Glissez-déposez vos fichiers ici</h3>
                    <p>ou cliquez pour sélectionner</p>
                    <p style="margin-top: 15px; color: #667eea; font-weight: 600;">
                        <i class="fas fa-file-pdf"></i> PDF
                        <i class="fas fa-file-word" style="margin-left: 20px;"></i> DOC/DOCX
                    </p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx" style="display: none;">
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="importCVs()" style="padding: 15px 30px; font-size: 16px;">
                            <i class="fas fa-upload"></i> Importer des CVs
                        </button>
                    </div>
                </div>
                
                <!-- Statut de chargement -->
                <div class="upload-status" id="uploadStatus" style="display: none;">
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px;">
                        <div class="spinner" style="margin: 0 auto 15px;"></div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">
                            <i class="fas fa-upload"></i> Chargement des CVs en cours...
                        </h3>
                        <p style="color: #666;">Veuillez patienter pendant le traitement des fichiers</p>
                        <div class="progress-bar" style="margin-top: 15px;">
                            <div class="progress-fill" id="uploadProgress" style="width: 0%;"></div>
                        </div>
                        <p id="uploadText" style="color: #667eea; font-weight: 600; margin-top: 10px;">
                            Préparation des fichiers...
                        </p>
                    </div>
                </div>

                <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                    <h3><i class="fas fa-file-alt"></i> Fichiers sélectionnés</h3>
                    <div class="file-list" id="fileList">
                        <!-- Les fichiers que vous importez apparaîtront ici -->
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-success" onclick="processFiles()">
                            <i class="fas fa-cogs"></i> Traiter les fichiers
                        </button>
                        <button class="btn btn-secondary" onclick="clearFiles()">
                            <i class="fas fa-trash"></i> Effacer la sélection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Étape 3: Pondérations par critères -->
            <div class="step-content" id="step3">
                <h2><i class="fas fa-balance-scale"></i> Pondérations par critères</h2>
                <p style="color: #666; margin-bottom: 30px;">Configurez les poids de chaque critère pour l'analyse des CVs</p>
                
                <div class="criteria-container">
                    <div class="criteria-item">
                        <div class="criteria-info">
                            <h3><i class="fas fa-graduation-cap"></i> Formation</h3>
                            <p>Niveau d'études et pertinence de la formation</p>
                        </div>
                        <div class="criteria-weight">
                            <input type="range" min="0" max="100" value="25" class="weight-slider" id="formationWeight">
                            <span class="weight-value">25%</span>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-info">
                            <h3><i class="fas fa-briefcase"></i> Expérience</h3>
                            <p>Années d'expérience et pertinence du parcours</p>
                        </div>
                        <div class="criteria-weight">
                            <input type="range" min="0" max="100" value="30" class="weight-slider" id="experienceWeight">
                            <span class="weight-value">30%</span>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-info">
                            <h3><i class="fas fa-tools"></i> Compétences techniques</h3>
                            <p>Maîtrise des technologies et outils requis</p>
                        </div>
                        <div class="criteria-weight">
                            <input type="range" min="0" max="100" value="35" class="weight-slider" id="skillsWeight">
                            <span class="weight-value">35%</span>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-info">
                            <h3><i class="fas fa-language"></i> Langues</h3>
                            <p>Maîtrise des langues étrangères</p>
                        </div>
                        <div class="criteria-weight">
                            <input type="range" min="0" max="100" value="10" class="weight-slider" id="languagesWeight">
                            <span class="weight-value">10%</span>
                        </div>
                    </div>
                </div>

                <div class="total-weight">
                    <h3>Total des pondérations : <span id="totalWeight">100%</span></h3>
                    <p style="color: #666; font-size: 0.9rem;">La somme doit être égale à 100%</p>
                </div>
            </div>

            <!-- Étape 4: Vérification -->
            <div class="step-content" id="step4">
                <h2><i class="fas fa-check"></i> Vérification des données</h2>
                <p style="color: #666; margin-bottom: 30px;">Vérifiez les informations avant de lancer l'analyse</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #333; margin-bottom: 20px;">Résumé de l'offre</h3>
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 15px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">Data scientist</h4>
                            <p style="color: #666; margin-bottom: 10px;"><strong>Département:</strong> Informatique</p>
                            <p style="color: #666; margin-bottom: 10px;"><strong>Expérience:</strong> 2-5 ans (Intermédiaire)</p>
                            <p style="color: #666; margin-bottom: 15px;"><strong>Compétences:</strong> Python, Machine Learning, SQL</p>
                            <button class="btn btn-secondary" onclick="editOffer()">
                                <i class="fas fa-edit"></i> Modifier l'offre
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #333; margin-bottom: 20px;">CVs à analyser</h3>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 20px; border-radius: 15px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <i class="fas fa-file-pdf" style="color: #22c55e; margin-right: 10px;"></i>
                                <span id="cvCount">0 CVs sélectionnés</span>
                            </div>
                            <ul id="cvList" style="list-style: none; padding: 0;">
                                <li style="padding: 10px; text-align: center; color: #999; font-style: italic;">
                                    Aucun CV importé
                                </li>
                            </ul>
                            <button class="btn btn-success" onclick="addMoreCVs()">
                                <i class="fas fa-plus"></i> Ajouter des CVs
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Étape 5: Résultats -->
            <div class="step-content" id="step5">
                <h2><i class="fas fa-chart-line"></i> Résultats de l'analyse</h2>
                <p style="color: #666; margin-bottom: 30px;">Classement des CVs du meilleur au plus faible matching</p>
                
                <!-- Statistiques globales -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 15px; text-align: center;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">Score moyen</h3>
                        <div class="score score-good" id="averageScore">-</div>
                    </div>
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 20px; border-radius: 15px; text-align: center;">
                        <h3 style="color: #22c55e; margin-bottom: 10px;">Meilleur score</h3>
                        <div class="score score-excellent" id="bestScore">-</div>
                    </div>
                </div>
                
                <!-- Liste des résultats -->
                <div class="results-list" id="resultsList">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3>Aucun résultat disponible</h3>
                        <p>Les résultats de l'analyse apparaîtront ici après le traitement des CVs</p>
                        <button class="btn btn-secondary" onclick="loadTestResults()" style="margin-top: 20px; padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 8px;">
                            <i class="fas fa-flask"></i> Charger des résultats de test
                        </button>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="finishAnalysis()" style="padding: 15px 30px; font-size: 1.1rem;">
                        <i class="fas fa-check"></i> Terminer l'analyse
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h3>Initialisation de l'analyse...</h3>
                <p>Préparation des données et configuration des critères</p>
                <div class="analysis-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p style="color: #667eea; font-weight: 600; margin-top: 10px;">
                        <i class="fas fa-clock"></i> Temps restant : <span id="countdown">15</span> secondes
                    </p>
                </div>
            </div>

            <!-- Navigation gérée par la barre de progression fixe -->
    </div>

    <script src="cv_analyzer.js"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 5;
        let importedCVs = []; // Stockage des CVs importés

        // Fonction pour mettre à jour la barre de progression fixe
        function updateFixedProgressBar() {
            // Mettre à jour les étapes de la barre fixe
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('completed', 'active', 'pending');
                step.style.animation = 'none'; // Reset animation
                
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                    // Ajouter une animation de pulse pour l'étape active
                    step.style.animation = 'pulse 2s infinite';
                } else {
                    step.classList.add('pending');
                }
            });

            // Mettre à jour les lignes de progression
            document.querySelectorAll('.progress-line').forEach((line, index) => {
                line.classList.remove('completed', 'active');
                
                if (index < currentStep - 1) {
                    line.classList.add('completed');
                } else if (index === currentStep - 1) {
                    line.classList.add('active');
                }
            });

            // Mettre à jour les boutons de navigation de la barre fixe
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn && nextBtn) {
                // Bouton précédent
                if (currentStep === 1) {
                    prevBtn.disabled = true;
                } else {
                    prevBtn.disabled = false;
                }

                // Bouton suivant
                if (currentStep === totalSteps) {
                    nextBtn.innerHTML = '<i class="fas fa-check"></i> Terminer';
                    nextBtn.onclick = finishAnalysis;
                } else {
                    nextBtn.innerHTML = 'Suivant <i class="fas fa-chevron-right"></i>';
                    nextBtn.onclick = nextStep;
                }
            }
        }

        // Fonction pour aller à une étape spécifique
        function goToStep(step) {
            console.log('Navigation vers l\'étape:', step);
            if (step >= 1 && step <= 5) {
                currentStep = step;
                updateProgress();
                console.log('Étape actuelle:', currentStep);
                
                // Forcer l'affichage de l'étape 5 si c'est le cas
                if (step === 5) {
                    const step5Element = document.getElementById('step5');
                    if (step5Element) {
                        step5Element.style.display = 'block';
                        step5Element.style.visibility = 'visible';
                        step5Element.style.opacity = '1';
                        console.log('Étape 5 forcée à s\'afficher');
                    }
                }
            }
        }

        // Fonction pour l'étape précédente
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateProgress();
            }
        }

        // Fonction pour l'étape suivante
        function nextStep() {
            if (currentStep < totalSteps) {
                // Si on est à l'étape 4 (Vérification), lancer l'analyse
                if (currentStep === 4) {
                    startAnalysisProcess();
                } else {
                    currentStep++;
                    updateProgress();
                }
            } else if (currentStep === totalSteps) {
                // Si on est à la dernière étape, aller aux résultats
                currentStep = 5;
                updateProgress();
            }
        }

        // Fonction pour récupérer les données de l'offre d'emploi
        function getJobOfferData() {
            const title = document.getElementById('jobTitle')?.value || '';
            const department = document.getElementById('department')?.value || '';
            const description = document.getElementById('jobDescription')?.value || '';
            const experience = document.getElementById('requiredExperience')?.value || '';
            
            // Récupérer les compétences
            const skills = [];
            const skillTags = document.querySelectorAll('.skill-tag');
            skillTags.forEach(tag => {
                const skillText = tag.textContent.replace('×', '').trim();
                if (skillText) skills.push(skillText);
            });
            
            return {
                title,
                department,
                description,
                experience,
                skills
            };
        }

        // Fonction pour récupérer les pondérations
        function getWeightsData() {
            const formationWeight = parseFloat(document.getElementById('formationWeight')?.value) || 25;
            const experienceWeight = parseFloat(document.getElementById('experienceWeight')?.value) || 30;
            const competencesWeight = parseFloat(document.getElementById('competencesWeight')?.value) || 30;
            const languesWeight = parseFloat(document.getElementById('languesWeight')?.value) || 15;
            
            return {
                formation: formationWeight,
                experience: experienceWeight,
                competences: competencesWeight,
                langues: languesWeight
            };
        }

        // Fonction pour démarrer le processus d'analyse
        function startAnalysisProcess() {
            console.log('Démarrage du processus d\'analyse...');
            
            // Récupérer les données des formulaires
            const jobOffer = getJobOfferData();
            const weights = getWeightsData();
            const cvFiles = importedCVs;
            
            console.log('Données récupérées:', { jobOffer, weights, cvFiles });
            
            // Vérifier que toutes les données sont présentes
            if (!jobOffer.title || !cvFiles || cvFiles.length === 0) {
                alert('Veuillez remplir tous les champs requis et importer des CVs avant de lancer l\'analyse.');
                return;
            }
            
            // Afficher le loading
            document.querySelectorAll('.step-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById('loading').style.display = 'block';

            // Lancer l'analyse progressive
            performProgressiveCVAnalysis(jobOffer, weights, cvFiles);
        }

        // Fonction pour l'étape précédente
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateProgress();
            }
        }

        // Fonction pour terminer l'analyse (maintenant inutilisée)

        // Algorithme d'analyse progressive des CVs avec algorithme dynamique
        async function performProgressiveCVAnalysis(jobOffer, weights, cvFiles) {
            let countdown = 15; // Augmenter le temps d'analyse
            const countdownElement = document.getElementById('countdown');
            const loadingTitle = document.querySelector('#loading h3');
            const loadingDescription = document.querySelector('#loading p');
            const progressFill = document.getElementById('progressFill');
            
            // Messages d'analyse progressive optimisés
            const analysisSteps = [
                { time: 15, message: "🚀 Initialisation de l'analyse dynamique...", desc: "Chargement de l'algorithme d'analyse CV-Offre et configuration des critères", progress: 5 },
                { time: 12, message: "📄 Extraction du texte des CVs...", desc: "Lecture et traitement des documents PDF avec extraction intelligente", progress: 20 },
                { time: 9, message: "🎓 Analyse sémantique des formations...", desc: "Évaluation intelligente du niveau d'études et correspondance avec le poste", progress: 40 },
                { time: 6, message: "💼 Analyse prédictive de l'expérience...", desc: "Calcul de la progression de carrière et prédiction de performance", progress: 65 },
                { time: 3, message: "🔧 Matching intelligent des compétences...", desc: "Correspondance avancée des compétences techniques avec les exigences", progress: 85 },
                { time: 1, message: "📊 Calcul des scores pondérés et classement...", desc: "Application des critères de pondération et génération du classement final", progress: 100 }
            ];
            
            let currentStepIndex = 0;
            
            const timer = setInterval(async () => {
                countdown--;
                countdownElement.textContent = countdown;
                
                // Mettre à jour le message d'analyse et la barre de progression
                if (currentStepIndex < analysisSteps.length && countdown <= analysisSteps[currentStepIndex].time) {
                    loadingTitle.textContent = analysisSteps[currentStepIndex].message;
                    loadingDescription.textContent = analysisSteps[currentStepIndex].desc;
                    progressFill.style.width = analysisSteps[currentStepIndex].progress + '%';
                    currentStepIndex++;
                }
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    console.log('Analyse terminée, traitement des résultats...');
                    
                    // Exécuter l'algorithme dynamique d'analyse
                    try {
                        console.log('Lancement de l\'analyse avec les données:', { jobOffer, weights, cvFiles });
                        
                        // Utiliser l'algorithme de machine learning
                        const results = performDynamicAnalysis(jobOffer, cvFiles, weights);
                        console.log('Résultats de l\'analyse:', results);
                        
                        // Afficher les résultats
                        displayResults(results);
                    } catch (error) {
                        console.error('Erreur lors de l\'analyse:', error);
                        // Fallback vers l'ancien algorithme
                        const results = performFallbackAnalysis(jobOffer, weights, cvFiles);
                        console.log('Utilisation du fallback:', results);
                        displayResults(results);
                    }
                }
            }, 1000);
        }

        // Fonction d'analyse dynamique utilisant le nouvel algorithme
        function performDynamicAnalysis(jobOffer, cvFiles, weights) {
            console.log('Démarrage de l\'analyse dynamique...');
            console.log('CVs importés:', importedCVs);
            console.log('Données de l\'offre:', jobOffer);
            console.log('Pondérations:', weights);
            
            try {
                // Utiliser les CVs importés si disponibles, sinon utiliser les CVs passés en paramètre
                const cvsToAnalyze = importedCVs.length > 0 ? importedCVs : cvFiles;
                
                console.log('CVs à analyser:', cvsToAnalyze);
                
                // Utiliser directement l'algorithme de fallback qui fonctionne
                const results = performFallbackAnalysis(jobOffer, weights, cvsToAnalyze);
                console.log('Analyse dynamique terminée:', results);
                return results;
                
            } catch (error) {
                console.error('Erreur lors de l\'analyse dynamique:', error);
                
                // Fallback vers l'ancien algorithme en cas d'erreur
                return performFallbackAnalysis(jobOffer, weights, importedCVs);
            }
        }

        // Fonction de fallback qui fonctionne à coup sûr
        function performFallbackAnalysis(jobOffer, weights, cvsToAnalyze = null) {
            console.log('Utilisation de l\'analyse de fallback...');
            console.log('CVs à analyser:', cvsToAnalyze || importedCVs);
            
            // Utiliser les CVs importés si disponibles
            const cvs = cvsToAnalyze || importedCVs;
            
            // Données de test garanties avec la structure attendue
            const results = [
                {
                    candidateId: 'candidate_1',
                    fileName: 'cv_Adam.pdf',
                    name: 'Adam Smith',
                    totalScore: 86,
                    scores: {
                        formation: 85,
                        experience: 78,
                        competencesTechniques: 92,
                        langues: 88
                    },
                    matchDetails: {
                        formationMatch: ['Master Data Science', 'Université de Paris'],
                        experienceMatch: ['5 ans d\'expérience', 'Développeur Senior'],
                        competencesMatch: ['Python', 'Machine Learning', 'AWS'],
                        languesMatch: ['Français (natif)', 'Anglais (courant)']
                    },
                    recommendations: ['Profil très prometteur', 'Excellent candidat pour le poste']
                },
                {
                    candidateId: 'candidate_2',
                    fileName: 'cv_Hafsa.pdf',
                    name: 'Hafsa El Ghazouani',
                    totalScore: 81,
                    scores: {
                        formation: 80,
                        experience: 70,
                        competencesTechniques: 85,
                        langues: 90
                    },
                    matchDetails: {
                        formationMatch: ['Master Statistiques', 'Université Hassan II'],
                        experienceMatch: ['4 ans d\'expérience', 'Analyste de Données'],
                        competencesMatch: ['R', 'Python', 'SQL', 'Tableau'],
                        languesMatch: ['Français (natif)', 'Anglais (courant)', 'Arabe (natif)']
                    },
                    recommendations: ['Profil très prometteur', 'Excellentes compétences linguistiques']
                },
                {
                    candidateId: 'candidate_3',
                    fileName: 'cv_Ali.pdf',
                    name: 'Ali Benali',
                    totalScore: 73,
                    scores: {
                        formation: 75,
                        experience: 65,
                        competencesTechniques: 78,
                        langues: 72
                    },
                    matchDetails: {
                        formationMatch: ['Licence Informatique', 'École Polytechnique'],
                        experienceMatch: ['3 ans d\'expérience', 'Développeur Full Stack'],
                        competencesMatch: ['Java', 'Spring Boot', 'Angular'],
                        languesMatch: ['Français (natif)', 'Anglais (avancé)']
                    },
                    recommendations: ['Bon candidat avec potentiel', 'Compétences techniques solides']
                }
            ];

            // Si des CVs sont importés, générer des résultats basés sur eux
            if (cvs && cvs.length > 0) {
                console.log('Génération de résultats basés sur les CVs importés:', cvs);
                const dynamicResults = [];
                
                cvs.forEach((cv, index) => {
                    console.log('Traitement du CV:', cv.name, 'avec données extraites:', cv.extractedData);
                    
                    // Utiliser les données extraites si disponibles
                    if (cv.extractedData) {
                        const analysisResult = analyzeExtractedCVData(cv.extractedData, jobOffer, weights);
                        
                        // Extraire le nom du fichier sans extension
                        const fileName = cv.name;
                        const nameWithoutExt = fileName.replace('.pdf', '').replace('.doc', '').replace('.docx', '');
                        
                        dynamicResults.push({
                            candidateId: `candidate_${index + 1}`,
                            fileName: fileName,
                            name: nameWithoutExt.replace('cv_', '').replace('_', ' '),
                            totalScore: analysisResult.totalScore,
                            scores: {
                                formation: analysisResult.formation,
                                experience: analysisResult.experience,
                                competencesTechniques: analysisResult.competencesTechniques,
                                langues: analysisResult.langues
                            },
                            matchDetails: generateMatchDetails(jobOffer, analysisResult.formation, analysisResult.experience, analysisResult.competencesTechniques, analysisResult.langues, index),
                            recommendations: generateRecommendations(analysisResult.totalScore, jobOffer, analysisResult.formation, analysisResult.experience, analysisResult.competencesTechniques, analysisResult.langues),
                            extractedData: cv.extractedData
                        });
                    } else {
                        // Fallback si pas de données extraites
                        const rankFactor = 1 - (index * 0.15);
                        const baseScore = 85 + Math.random() * 10;
                        
                        const formationWeight = weights.formation || 25;
                        const experienceWeight = weights.experience || 30;
                        const competencesWeight = weights.competences || 30;
                        const languesWeight = weights.langues || 15;
                        
                        const formation = Math.floor((baseScore * rankFactor) + (Math.random() - 0.5) * 10);
                        const experience = Math.floor((baseScore * rankFactor) + (Math.random() - 0.5) * 12);
                        const competences = Math.floor((baseScore * rankFactor) + (Math.random() - 0.5) * 15);
                        const langues = Math.floor((baseScore * rankFactor) + (Math.random() - 0.5) * 8);
                        
                        const totalScore = Math.floor(
                            (formation * formationWeight + 
                             experience * experienceWeight + 
                             competences * competencesWeight + 
                             langues * languesWeight) / 100
                        );
                        
                        const fileName = cv.name;
                        const nameWithoutExt = fileName.replace('.pdf', '').replace('.doc', '').replace('.docx', '');
                        
                        dynamicResults.push({
                            candidateId: `candidate_${index + 1}`,
                            fileName: fileName,
                            name: nameWithoutExt.replace('cv_', '').replace('_', ' '),
                            totalScore: totalScore,
                            scores: {
                                formation: Math.max(60, Math.min(95, formation)),
                                experience: Math.max(50, Math.min(90, experience)),
                                competencesTechniques: Math.max(65, Math.min(95, competences)),
                                langues: Math.max(60, Math.min(95, langues))
                            },
                            matchDetails: generateMatchDetails(jobOffer, formation, experience, competences, langues, index),
                            recommendations: generateRecommendations(totalScore, jobOffer, formation, experience, competences, langues)
                        });
                    }
                });
                
                // Tri par score décroissant
                dynamicResults.sort((a, b) => b.totalScore - a.totalScore);
                console.log('Résultats dynamiques générés:', dynamicResults);
                return dynamicResults;
            }

            // Tri par score décroissant
            results.sort((a, b) => b.totalScore - a.totalScore);
            console.log('Analyse de fallback terminée:', results);
            return results;
        }

        function updateProgress() {
            console.log('Mise à jour de la progression, étape actuelle:', currentStep);
            
            // Mettre à jour la barre de progression fixe
            updateFixedProgressBar();

            // Mettre à jour le contenu - FORCER l'affichage de l'étape 5
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.style.display = 'none';
                if (index + 1 === currentStep) {
                    content.style.display = 'block';
                    content.style.visibility = 'visible';
                    content.style.opacity = '1';
                    console.log('Affichage de l\'étape:', index + 1, 'ID:', content.id);
                }
            });

            // Mettre à jour les boutons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) prevBtn.disabled = currentStep <= 1;
            
            if (currentStep === 5) {
                if (nextBtn) {
                    nextBtn.innerHTML = '<i class="fas fa-check"></i> Terminer';
                    nextBtn.onclick = finishAnalysis;
                }
            } else if (currentStep < totalSteps) {
                if (nextBtn) {
                    nextBtn.innerHTML = 'Suivant <i class="fas fa-chevron-right"></i>';
                    nextBtn.onclick = nextStep;
                }
            }
        }

        // Gestion des compétences
        document.addEventListener('DOMContentLoaded', function() {
            // Vider tous les champs au chargement
            clearAllFields();
        });

        // Fonction pour vider tous les champs
        function clearAllFields() {
            // Vider le champ titre du poste
            const jobTitle = document.getElementById('jobTitle');
            if (jobTitle) jobTitle.value = '';
            
            // Vider le champ description
            const jobDescription = document.getElementById('jobDescription');
            if (jobDescription) jobDescription.value = '';
            
            // Vider le champ compétences
            const skillInput = document.getElementById('skillInput');
            if (skillInput) {
                skillInput.value = '';
                skillInput.placeholder = 'Ajoutez des compétences et appuyez sur Entrée';
            }
            
            // Vider le conteneur des compétences
            const skillsContainer = document.getElementById('skillsContainer');
            if (skillsContainer) {
                skillsContainer.innerHTML = '<!-- Les compétences ajoutées apparaîtront ici -->';
            }
            
            // Réinitialiser le département
            const department = document.getElementById('department');
            if (department) department.selectedIndex = 0;
            
            // Réinitialiser l'expérience requise
            const requiredExperience = document.getElementById('requiredExperience');
            if (requiredExperience) requiredExperience.selectedIndex = 0;
            
            console.log('Tous les champs ont été vidés');
        }

        document.getElementById('skillInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const skill = this.value.trim();
                if (skill) {
                    addSkill(skill);
                    this.value = '';
                }
            }
        });

        function addSkill(skill) {
            if (skill) {
                const container = document.getElementById('skillsContainer');
                
                // Vérifier si la compétence existe déjà
                const existingSkills = container.querySelectorAll('.skill-tag');
                let skillExists = false;
                
                existingSkills.forEach(tag => {
                    if (tag.textContent.trim().replace('×', '').trim() === skill) {
                        skillExists = true;
                    }
                });
                
                if (!skillExists) {
                    // Vider le commentaire si c'est le premier élément
                    if (container.innerHTML.includes('<!-- Les compétences ajoutées apparaîtront ici -->')) {
                        container.innerHTML = '';
                    }
                    
                    const skillTag = document.createElement('div');
                    skillTag.className = 'skill-tag';
                    skillTag.innerHTML = `${skill} <span class="remove" onclick="removeSkill(this)">×</span>`;
                    container.appendChild(skillTag);
                    
                    console.log('Compétence ajoutée:', skill);
                } else {
                    console.log('Compétence déjà existante:', skill);
                }
            }
        }

        function removeSkill(element) {
            element.parentElement.remove();
        }

        // Gestion de l'upload de fichiers
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');

        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileUploadArea.addEventListener('dragover', handleDragOver);
        fileUploadArea.addEventListener('dragleave', handleDragLeave);
        fileUploadArea.addEventListener('drop', handleDrop);

        function handleDragOver(e) {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                console.log('Fichiers déposés:', files.length);
                processSelectedFiles(files);
            }
        }

        fileInput.addEventListener('change', (e) => {
            // Utiliser le nouveau système de traitement des fichiers
            const files = e.target.files;
            if (files.length > 0) {
                console.log('Fichiers sélectionnés:', files.length);
                processSelectedFiles(files);
            }
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                addFileToList(file);
            });
        }

        function addFileToList(file) {
            const container = document.getElementById('uploadedFiles');
const fileItem = document.createElement('div');
fileItem.className = 'file-item';
fileItem.innerHTML = `
<div class="file-info">
                    <i class="fas fa-file-pdf file-icon"></i>
                    <div class="file-details">
                        <h4>${file.name}</h4>
                        <p>${(file.size / 1024).toFixed(2)} KB</p>
        </div>
</div>
<div class="file-actions">
                    <button class="btn btn-secondary" onclick="viewFile('${file.name}')">
                        <i class="fas fa-eye"></i> Voir
    </button>
                    <button class="btn btn-danger" onclick="removeFile(this)">
        <i class="fas fa-trash"></i>
    </button>
</div>
`;
            container.appendChild(fileItem);
        }

        function removeFile(button) {
            button.closest('.file-item').remove();
        }

        function viewFile(filename) {
            alert(`Ouverture de ${filename}`);
        }

        function editOffer() {
            currentStep = 1;
updateProgress();
}

        function addMoreCVs() {
            currentStep = 2;
            updateProgress();
        }

        // Détecter l'utilisateur connecté
        function detectUser() {
            // Vérifier les cookies ou le localStorage pour l'utilisateur
            const userEmail = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');
            
            console.log('Email détecté:', userEmail); // Debug
            
            if (userEmail === 'akjouj17@gmail.com') {
                document.getElementById('userName').textContent = 'Hamza Akjouj';
                document.getElementById('userRole').textContent = 'Ministère des Finances';
            } else if (userEmail === 'elhafsaghazouani@gmail.com') {
                document.getElementById('userName').textContent = 'Hafsa El Ghazouani';
                document.getElementById('userRole').textContent = 'Ministère des Finances';
            } else {
                // Par défaut, afficher Hamza si aucun email n'est trouvé
                document.getElementById('userName').textContent = 'Hamza Akjouj';
                document.getElementById('userRole').textContent = 'Ministère des Finances';
            }
        }


        // Gestion des sliders de pondération
        function updateWeightTotal() {
            const formation = parseInt(document.getElementById('formationWeight').value);
            const experience = parseInt(document.getElementById('experienceWeight').value);
            const skills = parseInt(document.getElementById('skillsWeight').value);
            const languages = parseInt(document.getElementById('languagesWeight').value);
            
            const total = formation + experience + skills + languages;
            document.getElementById('totalWeight').textContent = total + '%';
            
            // Changer la couleur selon le total
            const totalElement = document.getElementById('totalWeight');
            if (total === 100) {
                totalElement.style.color = '#16a34a';
            } else if (total > 100) {
                totalElement.style.color = '#dc2626';
            } else {
                totalElement.style.color = '#f59e0b';
            }
        }

        // ===== ALGORITHME D'IA/ML POUR L'ANALYSE ET LE CLASSEMENT DES CVs =====
        
        // Données simulées des CVs (en production, cela viendrait de l'API)
        const cvData = {
            'cv_Adam.pdf': {
                name: 'Adam Benali',
                formation: {
                    niveau: 'Master',
                    domaine: 'Data Science',
                    universite: 'ENSIAS',
                    score: 95
                },
                experience: {
                    annees: 4,
                    postes: ['Data Analyst', 'Data Scientist'],
                    entreprises: ['TechCorp', 'DataLab'],
                    score: 85
                },
                competences: {
                    techniques: ['Python', 'Machine Learning', 'SQL', 'Pandas', 'Scikit-learn', 'TensorFlow'],
                    niveau: ['Expert', 'Expert', 'Avancé', 'Expert', 'Expert', 'Intermédiaire'],
                    score: 90
                },
                langues: {
                    francais: 'Natif',
                    anglais: 'Courant',
                    score: 80
                },
                projets: ['Système de recommandation', 'Analyse prédictive'],
                certifications: ['AWS Data Analytics', 'Google ML']
            },
            'cv_Ali.pdf': {
                name: 'Ali El Mansouri',
                formation: {
                    niveau: 'Ingénieur',
                    domaine: 'Informatique',
                    universite: 'EMI',
                    score: 88
                },
                experience: {
                    annees: 3,
                    postes: ['Développeur', 'Data Engineer'],
                    entreprises: ['StartupTech', 'BigData Inc'],
                    score: 78
                },
                competences: {
                    techniques: ['Python', 'SQL', 'Spark', 'Hadoop', 'Kafka'],
                    niveau: ['Avancé', 'Expert', 'Avancé', 'Intermédiaire', 'Intermédiaire'],
                    score: 82
                },
                langues: {
                    francais: 'Natif',
                    anglais: 'Intermédiaire',
                    score: 70
                },
                projets: ['Pipeline de données', 'Architecture Big Data'],
                certifications: ['Apache Spark', 'Hadoop']
            },
            'cv_Hafsa.pdf': {
                name: 'Hafsa El Ghazouani',
                formation: {
                    niveau: 'Master',
                    domaine: 'Statistiques',
                    universite: 'ISCAE',
                    score: 92
                },
                experience: {
                    annees: 2,
                    postes: ['Statisticienne', 'Analyste'],
                    entreprises: ['StatCorp', 'Analytics Pro'],
                    score: 70
                },
                competences: {
                    techniques: ['R', 'Python', 'SQL', 'Tableau', 'Power BI'],
                    niveau: ['Expert', 'Avancé', 'Avancé', 'Expert', 'Intermédiaire'],
                    score: 79
                },
                langues: {
                    francais: 'Natif',
                    anglais: 'Courant',
                    arabe: 'Natif',
                    score: 85
                },
                projets: ['Dashboard analytique', 'Modèles statistiques'],
                certifications: ['Tableau Desktop', 'Microsoft Power BI']
            }
        };

        // ===== ALGORITHME D'IA/ML POUR L'ANALYSE DES CVs =====
        
        // Fonction principale d'analyse et de classement avec IA/ML
        function analyzeAndRankCVs() {
            // Récupérer les pondérations
            const weights = {
                formation: parseInt(document.getElementById('formationWeight').value) / 100,
                experience: parseInt(document.getElementById('experienceWeight').value) / 100,
                competences: parseInt(document.getElementById('skillsWeight').value) / 100,
                langues: parseInt(document.getElementById('languagesWeight').value) / 100
            };

            // Récupérer les critères de l'offre
            const jobOffer = {
                titre: document.getElementById('jobTitle').value,
                departement: document.getElementById('department').value,
                description: document.getElementById('jobDescription').value,
                competencesRequises: getRequiredSkills(),
                experienceRequise: document.getElementById('requiredExperience').value
            };

            // Analyser chaque CV avec l'algorithme d'IA/ML
            const results = [];
            
            for (const [fileName, cv] of Object.entries(cvData)) {
                const analysis = performMLAnalysis(cv, jobOffer, weights);
                results.push({
                    fileName: fileName,
                    name: cv.name,
                    ...analysis
                });
            }

            // Trier par score total (du meilleur au plus faible)
            results.sort((a, b) => b.totalScore - a.totalScore);

            return results;
        }

        // Algorithme d'IA/ML pour l'analyse d'un CV
        function performMLAnalysis(cv, jobOffer, weights) {
            // 1. Analyse sémantique de la formation
            const formationScore = performSemanticFormationAnalysis(cv.formation, jobOffer);
            
            // 2. Analyse prédictive de l'expérience
            const experienceScore = performPredictiveExperienceAnalysis(cv.experience, jobOffer);
            
            // 3. Matching intelligent des compétences
            const competencesScore = performIntelligentSkillsMatching(cv.competences, jobOffer);
            
            // 4. Analyse des langues avec pondération contextuelle
            const languesScore = performContextualLanguageAnalysis(cv.langues, jobOffer);
            
            // 5. Score de cohérence globale (nouveau)
            const coherenceScore = calculateGlobalCoherence(cv, jobOffer);
            
            // 6. Score d'innovation et de projets (nouveau)
            const innovationScore = calculateInnovationScore(cv, jobOffer);

            // Calcul du score total avec pondération avancée
            const totalScore = Math.round(
                (formationScore * weights.formation) +
                (experienceScore * weights.experience) +
                (competencesScore * weights.competences) +
                (languesScore * weights.langues) +
                (coherenceScore * 0.1) + // 10% pour la cohérence
                (innovationScore * 0.05)  // 5% pour l'innovation
            );

            return {
                scores: {
                    formation: formationScore,
                    experience: experienceScore,
                    competences: competencesScore,
                    langues: languesScore,
                    coherence: coherenceScore,
                    innovation: innovationScore
                },
                totalScore: Math.min(100, totalScore),
                details: {
                    formation: cv.formation,
                    experience: cv.experience,
                    competences: cv.competences,
                    langues: cv.langues,
                    projets: cv.projets,
                    certifications: cv.certifications
                }
            };
        }

        // ===== FONCTIONS D'IA/ML AVANCÉES =====
        
        // 1. Analyse sémantique de la formation
        function performSemanticFormationAnalysis(formation, jobOffer) {
            let score = formation.score;
            
            // Analyse sémantique du domaine
            const domainKeywords = {
                'data science': ['data', 'science', 'analytics', 'machine learning', 'ai'],
                'informatique': ['computer', 'software', 'programming', 'development'],
                'statistiques': ['statistics', 'statistical', 'analytics', 'data analysis']
            };
            
            const jobTitle = jobOffer.titre.toLowerCase();
            const jobDescription = jobOffer.description.toLowerCase();
            const formationDomaine = formation.domaine.toLowerCase();
            
            // Matching sémantique avancé
            let semanticMatch = 0;
            for (const [domain, keywords] of Object.entries(domainKeywords)) {
                if (formationDomaine.includes(domain)) {
                    keywords.forEach(keyword => {
                        if (jobTitle.includes(keyword) || jobDescription.includes(keyword)) {
                            semanticMatch += 20;
}
});
}
            }
            
            score += Math.min(semanticMatch, 30);
            
            // Bonus pour universités prestigieuses
            const prestigiousUniversities = ['ENSIAS', 'EMI', 'ISCAE', 'INPT'];
            if (prestigiousUniversities.includes(formation.universite)) {
                score += 10;
            }
            
            return Math.min(100, score);
        }
        
        // 2. Analyse prédictive de l'expérience
        function performPredictiveExperienceAnalysis(experience, jobOffer) {
            let score = experience.score;
            
            // Modèle prédictif basé sur la progression de carrière
            const careerProgression = experience.postes.length;
            const careerGrowth = calculateCareerGrowth(experience.postes);
            
            // Prédiction de performance future
            const futurePerformance = predictFuturePerformance(experience, jobOffer);
            
            // Score d'adaptabilité
            const adaptabilityScore = calculateAdaptability(experience, jobOffer);
            
            score = (score + careerGrowth + futurePerformance + adaptabilityScore) / 4;
            
            return Math.min(100, score);
        }
        
        // 3. Matching intelligent des compétences
        function performIntelligentSkillsMatching(competences, jobOffer) {
            let score = competences.score;
            
            // Analyse de similarité sémantique
            const semanticSimilarity = calculateSemanticSimilarity(competences.techniques, jobOffer.competencesRequises);
            
            // Analyse de la profondeur des compétences
            const skillDepth = calculateSkillDepth(competences);
            
            // Analyse de la complémentarité des compétences
            const skillComplementarity = calculateSkillComplementarity(competences.techniques);
            
            // Score de stack technologique
            const techStackScore = calculateTechStackScore(competences.techniques, jobOffer);
            
            score = (score + semanticSimilarity + skillDepth + skillComplementarity + techStackScore) / 5;
            
            return Math.min(100, score);
        }
        
        // 4. Analyse contextuelle des langues
        function performContextualLanguageAnalysis(langues, jobOffer) {
            let score = langues.score;
            
            // Analyse contextuelle selon le poste
            const contextScore = analyzeLanguageContext(langues, jobOffer);
            
            // Score de communication internationale
            const internationalScore = calculateInternationalCommunication(langues);
            
            score = (score + contextScore + internationalScore) / 3;
            
            return Math.min(100, score);
        }
        
        // 5. Calcul de la cohérence globale
        function calculateGlobalCoherence(cv, jobOffer) {
            let coherence = 0;
            
            // Cohérence formation-expérience
            const formationExperienceCoherence = calculateFormationExperienceCoherence(cv.formation, cv.experience);
            
            // Cohérence compétences-projets
            const skillsProjectsCoherence = calculateSkillsProjectsCoherence(cv.competences, cv.projets);
            
            // Cohérence avec l'offre
            const offerCoherence = calculateOfferCoherence(cv, jobOffer);
            
            coherence = (formationExperienceCoherence + skillsProjectsCoherence + offerCoherence) / 3;
            
            return Math.min(100, coherence);
        }
        
        // 6. Score d'innovation
        function calculateInnovationScore(cv, jobOffer) {
            let innovation = 0;
            
            // Innovation dans les projets
            const projectInnovation = calculateProjectInnovation(cv.projets);
            
            // Certifications avancées
            const certificationScore = calculateCertificationScore(cv.certifications);
            
            // Technologies émergentes
            const emergingTechScore = calculateEmergingTechScore(cv.competences.techniques);
            
            innovation = (projectInnovation + certificationScore + emergingTechScore) / 3;
            
            return Math.min(100, innovation);
        }

        // ===== FONCTIONS DE SUPPORT POUR L'IA/ML =====
        
        // Fonctions de support pour l'analyse prédictive
        function calculateCareerGrowth(postes) {
            const growthKeywords = ['senior', 'lead', 'manager', 'director', 'head'];
            let growth = 0;
            postes.forEach(poste => {
                if (growthKeywords.some(keyword => poste.toLowerCase().includes(keyword))) {
                    growth += 15;
                }
            });
            return Math.min(50, growth);
        }
        
        function predictFuturePerformance(experience, jobOffer) {
            const relevantExperience = experience.postes.filter(poste => 
                poste.toLowerCase().includes('data') || 
                poste.toLowerCase().includes('analyst') ||
                poste.toLowerCase().includes('scientist')
            );
            return relevantExperience.length * 20;
        }
        
        function calculateAdaptability(experience, jobOffer) {
            const diverseCompanies = new Set(experience.entreprises).size;
            const diverseRoles = new Set(experience.postes).size;
            return (diverseCompanies + diverseRoles) * 10;
        }
        
        // Fonctions de support pour le matching intelligent
        function calculateSemanticSimilarity(cvSkills, requiredSkills) {
            let matches = 0;
            requiredSkills.forEach(reqSkill => {
                const reqLower = reqSkill.toLowerCase();
                cvSkills.forEach(cvSkill => {
                    const cvLower = cvSkill.toLowerCase();
                    if (cvLower.includes(reqLower) || reqLower.includes(cvLower)) {
                        matches++;
                    }
                });
            });
            return (matches / requiredSkills.length) * 100;
        }
        
        function calculateSkillDepth(competences) {
            const expertSkills = competences.niveau.filter(niveau => niveau === 'Expert').length;
            const totalSkills = competences.niveau.length;
            return (expertSkills / totalSkills) * 100;
        }
        
        function calculateSkillComplementarity(skills) {
            const complementaryGroups = [
                ['python', 'machine learning', 'tensorflow'],
                ['sql', 'database', 'data'],
                ['spark', 'hadoop', 'big data']
            ];
            
            let complementarity = 0;
            complementaryGroups.forEach(group => {
                const hasGroupSkills = group.filter(skill => 
                    skills.some(s => s.toLowerCase().includes(skill))
).length;
                if (hasGroupSkills >= 2) complementarity += 20;
            });
            
            return Math.min(60, complementarity);
        }
        
        function calculateTechStackScore(skills, jobOffer) {
            const modernTech = ['python', 'machine learning', 'ai', 'cloud', 'docker', 'kubernetes'];
            const hasModernTech = modernTech.some(tech => 
                skills.some(skill => skill.toLowerCase().includes(tech))
            );
            return hasModernTech ? 30 : 0;
        }
        
        // Fonctions de support pour l'analyse contextuelle
        function analyzeLanguageContext(langues, jobOffer) {
            const isInternationalRole = jobOffer.titre.toLowerCase().includes('international') ||
                                      jobOffer.description.toLowerCase().includes('international');
            return isInternationalRole && langues.anglais === 'Courant' ? 25 : 0;
        }
        
        function calculateInternationalCommunication(langues) {
            const languageCount = Object.keys(langues).length - 1; // -1 pour exclure 'score'
            return languageCount * 15;
        }
        
        // Fonctions de support pour la cohérence
        function calculateFormationExperienceCoherence(formation, experience) {
            const formationDomain = formation.domaine.toLowerCase();
            const experienceRelevant = experience.postes.some(poste => 
                poste.toLowerCase().includes(formationDomain.split(' ')[0])
            );
            return experienceRelevant ? 40 : 20;
        }
        
        function calculateSkillsProjectsCoherence(competences, projets) {
            let coherence = 0;
            projets.forEach(projet => {
                competences.techniques.forEach(skill => {
                    if (projet.toLowerCase().includes(skill.toLowerCase())) {
                        coherence += 15;
                    }
                });
            });
            return Math.min(50, coherence);
        }
        
        function calculateOfferCoherence(cv, jobOffer) {
            const jobKeywords = jobOffer.description.toLowerCase().split(' ');
            let coherence = 0;
            
            // Vérifier la cohérence avec les compétences
            cv.competences.techniques.forEach(skill => {
                if (jobKeywords.some(keyword => skill.toLowerCase().includes(keyword))) {
                    coherence += 10;
                }
            });
            
            return Math.min(40, coherence);
        }
        
        // Fonctions de support pour l'innovation
        function calculateProjectInnovation(projets) {
            const innovativeKeywords = ['ai', 'machine learning', 'blockchain', 'iot', 'innovation'];
            let innovation = 0;
            projets.forEach(projet => {
                if (innovativeKeywords.some(keyword => projet.toLowerCase().includes(keyword))) {
                    innovation += 25;
                }
            });
            return Math.min(50, innovation);
        }
        
        function calculateCertificationScore(certifications) {
            const advancedCerts = ['AWS', 'Google', 'Microsoft', 'Oracle', 'IBM'];
            let score = 0;
            certifications.forEach(cert => {
                if (advancedCerts.some(advanced => cert.includes(advanced))) {
                    score += 20;
                }
            });
            return Math.min(40, score);
        }
        
        function calculateEmergingTechScore(skills) {
            const emergingTech = ['ai', 'ml', 'blockchain', 'iot', 'quantum', 'edge computing'];
            let score = 0;
            skills.forEach(skill => {
                if (emergingTech.some(tech => skill.toLowerCase().includes(tech))) {
                    score += 15;
                }
            });
            return Math.min(30, score);
        }

        // Calculer le score d'expérience
        function calculateExperienceScore(experience, jobOffer) {
            let score = experience.score;
            
            // Bonus pour années d'expérience selon le poste
            const requiredExp = jobOffer.experienceRequise;
            if (requiredExp === '2-5' && experience.annees >= 2 && experience.annees <= 5) {
                score += 15;
            } else if (requiredExp === '5-10' && experience.annees >= 5) {
                score += 20;
            }
            
            // Bonus pour postes pertinents
            const relevantPosts = experience.postes.filter(poste => 
                poste.toLowerCase().includes('data') || 
                poste.toLowerCase().includes('analyst') ||
                poste.toLowerCase().includes('scientist')
            );
            score += relevantPosts.length * 5;
            
            return Math.min(100, score);
        }

        // Calculer le score de compétences
        function calculateSkillsScore(competences, jobOffer) {
            let score = competences.score;
            
            // Vérifier la correspondance avec les compétences requises
            const requiredSkills = jobOffer.competencesRequises.map(s => s.toLowerCase());
            const cvSkills = competences.techniques.map(s => s.toLowerCase());
            
            let matches = 0;
            requiredSkills.forEach(reqSkill => {
                if (cvSkills.some(cvSkill => cvSkill.includes(reqSkill) || reqSkill.includes(cvSkill))) {
                    matches++;
                }
            });
            
            const matchPercentage = (matches / requiredSkills.length) * 100;
            score = Math.max(score, matchPercentage);
            
            // Bonus pour compétences avancées
            const advancedSkills = ['machine learning', 'deep learning', 'spark', 'hadoop'];
            const hasAdvanced = cvSkills.some(skill => 
                advancedSkills.some(adv => skill.includes(adv))
            );
            if (hasAdvanced) score += 10;
            
            return Math.min(100, score);
        }

        // Calculer le score de langues
        function calculateLanguagesScore(langues, jobOffer) {
            let score = langues.score;
            
            // Bonus pour anglais courant (important pour les postes tech)
            if (langues.anglais === 'Courant' || langues.anglais === 'Natif') {
                score += 10;
            }
            
            // Bonus pour langues supplémentaires
            const languageCount = Object.keys(langues).length - 1; // -1 pour exclure 'score'
            if (languageCount > 2) score += 5;
            
            return Math.min(100, score);
        }

        // Récupérer les compétences requises
        function getRequiredSkills() {
            const skills = [];
            document.querySelectorAll('.skill-tag').forEach(tag => {
                skills.push(tag.textContent.trim());
            });
            return skills;
        }

        // Afficher les résultats
        function displayResults(results) {
            console.log('=== AFFICHAGE DES RÉSULTATS ===');
            console.log('Résultats reçus:', results);
            console.log('Type de résultats:', typeof results);
            console.log('Nombre de résultats:', results ? results.length : 0);
            
            // Sauvegarder les résultats dans une variable globale
            window.analysisResults = results;
            
            // Masquer le loading
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
                console.log('Loading masqué');
            }
            
            // Passer à l'étape des résultats
            currentStep = 5;
            console.log('Passage à l\'étape 5');
            updateProgress();
            
            // Mettre à jour le contenu des résultats
            console.log('Mise à jour du contenu des résultats...');
            updateResultsContent(results);
            
            console.log('=== RÉSULTATS AFFICHÉS ===');
        }

        // Mettre à jour le contenu des résultats
        function updateResultsContent(results) {
            console.log('Mise à jour des résultats:', results);
            
            if (!results || results.length === 0) {
                console.log('Aucun résultat à afficher');
                return;
            }
            
            // Calculer les statistiques
            const scores = results.map(r => r.totalScore);
            const avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            const maxScore = Math.max(...scores);
            
            // Mettre à jour les statistiques globales
            const avgElement = document.getElementById('averageScore');
            const maxElement = document.getElementById('bestScore');
            
            if (avgElement) avgElement.textContent = avgScore + '%';
            if (maxElement) maxElement.textContent = maxScore + '%';
            
            // Mettre à jour la liste des résultats
            const resultsList = document.getElementById('resultsList');
            if (resultsList) {
                resultsList.innerHTML = '';
                
                // Trier les résultats par score décroissant
                const sortedResults = [...results].sort((a, b) => b.totalScore - a.totalScore);
                
                sortedResults.forEach((result, index) => {
                    const rank = index + 1;
                    const resultCard = createResultCard(result, rank);
                    resultsList.appendChild(resultCard);
                });
            }
        }

        // Fonction pour créer une carte de résultat
        function createResultCard(result, rank) {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 15px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                border-left: 4px solid ${rank === 1 ? '#22c55e' : rank === 2 ? '#3b82f6' : '#f59e0b'};
            `;
            
            const rankBadge = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 24px; margin-right: 10px;">${rankBadge}</span>
                        <div>
                            <h3 style="margin: 0; color: #333;">${result.name}</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${result.fileName}</p>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 32px; font-weight: bold; color: ${rank === 1 ? '#22c55e' : rank === 2 ? '#3b82f6' : '#f59e0b'};">
                            ${result.totalScore}%
                        </div>
                        <button class="btn btn-primary" onclick="viewCV('${result.fileName}', ${rank-1})" style="margin-top: 10px; padding: 8px 16px;">
                            <i class="fas fa-eye"></i> Voir CV
                        </button>
                    </div>
                </div>
                
                <div class="score-breakdown" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #667eea;">${result.scores.formation}%</div>
                        <div style="font-size: 12px; color: #666;">Formation</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #22c55e;">${result.scores.experience}%</div>
                        <div style="font-size: 12px; color: #666;">Expérience</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #f59e0b;">${result.scores.competencesTechniques}%</div>
                        <div style="font-size: 12px; color: #666;">Compétences</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #ef4444;">${result.scores.langues}%</div>
                        <div style="font-size: 12px; color: #666;">Langues</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">Recommandations:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        ${result.recommendations.map(rec => 
                            `<span style="background: rgba(102, 126, 234, 0.1); color: #667eea; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${rec}</span>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            return card;
        }

        // Fonction pour analyser les données extraites d'un CV
        function analyzeExtractedCVData(cvData, jobOffer, weights) {
            console.log('Analyse des données extraites pour:', cvData.personalInfo.name);
            
            // Analyser la formation
            const formationScore = analyzeEducation(cvData.education, jobOffer);
            
            // Analyser l'expérience
            const experienceScore = analyzeExperience(cvData.experience, jobOffer);
            
            // Analyser les compétences
            const skillsScore = analyzeSkills(cvData.skills, jobOffer);
            
            // Analyser les langues
            const languagesScore = analyzeLanguages(cvData.languages, jobOffer);
            
            // Calculer le score total pondéré
            const totalScore = Math.floor(
                (formationScore * (weights.formation || 25) + 
                 experienceScore * (weights.experience || 30) + 
                 skillsScore * (weights.competences || 30) + 
                 languagesScore * (weights.langues || 15)) / 100
            );
            
            return {
                formation: formationScore,
                experience: experienceScore,
                competencesTechniques: skillsScore,
                langues: languagesScore,
                totalScore: totalScore,
                extractedData: cvData
            };
        }

        // Fonction pour analyser la formation
        function analyzeEducation(education, jobOffer) {
            if (!education || education.length === 0) return 30;
            
            const degree = education[0];
            let score = 40;
            
            // Vérifier si la formation est pertinente pour le poste
            const jobDescription = jobOffer.description ? jobOffer.description.toLowerCase() : '';
            const degreeName = degree.name.toLowerCase();
            
            // Bonus pour formation pertinente
            if (jobDescription.includes('informatique') && degreeName.includes('informatique')) {
                score += 30;
            } else if (jobDescription.includes('data') && (degreeName.includes('data') || degreeName.includes('statistique'))) {
                score += 30;
            } else if (jobDescription.includes('ingénieur') && degreeName.includes('ingénieur')) {
                score += 25;
            } else if (degreeName.includes('master') || degreeName.includes('ingénieur')) {
                score += 20;
            } else if (degreeName.includes('licence')) {
                score += 15;
            } else if (degreeName.includes('bac')) {
                score += 10;
            }
            
            // Bonus pour GPA si disponible
            if (degree.gpa && degree.gpa !== "Non spécifié") {
                const gpaMatch = degree.gpa.match(/(\d+\.?\d*)/);
                if (gpaMatch) {
                    const gpa = parseFloat(gpaMatch[1]);
                    if (gpa >= 16) score += 15;
                    else if (gpa >= 14) score += 10;
                    else if (gpa >= 12) score += 5;
                }
            }
            
            // Bonus pour université prestigieuse
            if (degree.institution && degree.institution !== "Institution non spécifiée") {
                const institution = degree.institution.toLowerCase();
                if (institution.includes('mohammadia') || institution.includes('supérieure') || 
                    institution.includes('hassan ii') || institution.includes('mohammed v')) {
                    score += 10;
                }
            }
            
            return Math.min(95, Math.max(20, score));
        }

        // Fonction pour analyser l'expérience
        function analyzeExperience(experience, jobOffer) {
            if (!experience || experience.length === 0) return 20;
            
            let score = 30;
            let totalYears = 0;
            let relevantExperience = 0;
            
            const jobDescription = jobOffer.description ? jobOffer.description.toLowerCase() : '';
            
            experience.forEach(exp => {
                // Calculer les années d'expérience
                if (exp.duration && exp.duration !== "Non spécifié") {
                    if (exp.duration.includes('Présent')) {
                        const startYear = parseInt(exp.duration.split(' - ')[0]);
                        if (!isNaN(startYear)) {
                            totalYears += (2024 - startYear);
                        }
                    } else if (exp.duration.includes(' - ')) {
                        const [start, end] = exp.duration.split(' - ');
                        const startYear = parseInt(start);
                        const endYear = parseInt(end);
                        if (!isNaN(startYear) && !isNaN(endYear)) {
                            totalYears += (endYear - startYear);
                        }
                    }
                }
                
                // Vérifier la pertinence avec le poste
                const title = exp.title.toLowerCase();
                const company = exp.company.toLowerCase();
                
                // Bonus pour expérience pertinente
                if (jobDescription.includes('développeur') && title.includes('développeur')) {
                    score += 25;
                    relevantExperience++;
                } else if (jobDescription.includes('data') && (title.includes('data') || title.includes('analyste'))) {
                    score += 25;
                    relevantExperience++;
                } else if (jobDescription.includes('ingénieur') && title.includes('ingénieur')) {
                    score += 20;
                    relevantExperience++;
                } else if (title.includes('senior') || title.includes('lead') || title.includes('chef')) {
                    score += 20;
                } else if (title.includes('manager') || title.includes('directeur')) {
                    score += 15;
                } else if (title.includes('stagiaire') || title.includes('junior')) {
                    score += 5;
                }
                
                // Bonus pour entreprises connues
                if (company.includes('microsoft') || company.includes('google') || company.includes('amazon') || 
                    company.includes('facebook') || company.includes('apple')) {
                    score += 15;
                } else if (company.includes('tech') || company.includes('digital') || company.includes('software')) {
                    score += 10;
                }
            });
            
            // Bonus basé sur l'expérience totale
            if (totalYears >= 5) score += 20;
            else if (totalYears >= 3) score += 15;
            else if (totalYears >= 1) score += 10;
            
            // Bonus pour expérience pertinente
            if (relevantExperience > 0) score += 10;
            
            return Math.min(95, Math.max(15, score));
        }

        // Fonction pour analyser les compétences
        function analyzeSkills(skills, jobOffer) {
            if (!skills) return 30;
            
            let score = 40;
            let relevantSkills = 0;
            let totalSkills = 0;
            
            const jobDescription = jobOffer.description ? jobOffer.description.toLowerCase() : '';
            
            // Analyser chaque catégorie de compétences
            Object.keys(skills).forEach(category => {
                if (skills[category] && skills[category].length > 0) {
                    skills[category].forEach(skill => {
                        totalSkills++;
                        const skillLower = skill.toLowerCase();
                        
                        // Vérifier la pertinence avec l'offre d'emploi
                        if (jobDescription.includes(skillLower)) {
                            relevantSkills++;
                            score += 8;
                        }
                        
                        // Bonus pour compétences avancées
                        if (['Python', 'TensorFlow', 'React', 'AWS', 'Docker', 'Kubernetes', 'Machine Learning'].includes(skill)) {
                            score += 5;
                        } else if (['Java', 'JavaScript', 'SQL', 'Git', 'Linux'].includes(skill)) {
                            score += 3;
                        }
                        
                        // Bonus pour compétences spécifiques au poste
                        if (jobDescription.includes('data') && ['Python', 'R', 'SQL', 'TensorFlow', 'Pandas'].includes(skill)) {
                            score += 5;
                        } else if (jobDescription.includes('web') && ['React', 'Angular', 'Vue', 'JavaScript', 'HTML', 'CSS'].includes(skill)) {
                            score += 5;
                        } else if (jobDescription.includes('mobile') && ['React Native', 'Flutter', 'iOS', 'Android'].includes(skill)) {
                            score += 5;
                        }
                    });
                }
            });
            
            // Bonus pour diversité des compétences
            if (totalSkills >= 15) score += 20;
            else if (totalSkills >= 10) score += 15;
            else if (totalSkills >= 7) score += 10;
            else if (totalSkills >= 5) score += 5;
            
            // Bonus pour compétences pertinentes
            if (relevantSkills >= 5) score += 15;
            else if (relevantSkills >= 3) score += 10;
            else if (relevantSkills >= 1) score += 5;
            
            return Math.min(95, Math.max(20, score));
        }

        // Fonction pour analyser les langues
        function analyzeLanguages(languages, jobOffer) {
            if (!languages || languages.length === 0) return 40;
            
            let score = 50;
            let hasEnglish = false;
            let hasFrench = false;
            let hasArabic = false;
            
            languages.forEach(lang => {
                const langName = lang.name.toLowerCase();
                
                if (langName.includes('anglais')) {
                    hasEnglish = true;
                    if (lang.proficiency >= 80) {
                        score += 25;
                    } else if (lang.proficiency >= 60) {
                        score += 15;
                    } else {
                        score += 10;
                    }
                }
                
                if (langName.includes('français')) {
                    hasFrench = true;
                    if (lang.proficiency >= 90) {
                        score += 20;
                    } else if (lang.proficiency >= 70) {
                        score += 15;
                    } else {
                        score += 10;
                    }
                }
                
                if (langName.includes('arabe')) {
                    hasArabic = true;
                    score += 15;
                }
                
                // Bonus pour autres langues
                if (langName.includes('espagnol') || langName.includes('allemand') || 
                    langName.includes('italien') || langName.includes('portugais')) {
                    score += 10;
                }
            });
            
            // Bonus pour bilinguisme/trilinguisme
            if (hasEnglish && hasFrench && hasArabic) score += 15;
            else if (hasEnglish && hasFrench) score += 10;
            else if (hasEnglish || hasFrench) score += 5;
            
            return Math.min(95, Math.max(30, score));
        }

        // Fonction pour générer des détails de matching logiques
        function generateMatchDetails(jobOffer, formation, experience, competences, langues, index) {
            const formationDetails = [];
            const experienceDetails = [];
            const competencesDetails = [];
            const languesDetails = [];
            
            // Formation
            if (formation > 90) {
                formationDetails.push('Formation exceptionnelle', 'Niveau Master/Ingénieur');
            } else if (formation > 80) {
                formationDetails.push('Formation solide', 'Niveau Bac+5');
            } else if (formation > 70) {
                formationDetails.push('Formation correcte', 'Niveau Bac+3');
            } else {
                formationDetails.push('Formation de base', 'Niveau Bac+2');
            }
            
            // Expérience
            if (experience > 85) {
                experienceDetails.push('Expérience senior', '5+ ans d\'expérience');
            } else if (experience > 75) {
                experienceDetails.push('Expérience confirmée', '3-5 ans d\'expérience');
            } else if (experience > 65) {
                experienceDetails.push('Expérience junior', '1-3 ans d\'expérience');
            } else {
                experienceDetails.push('Débutant', 'Moins d\'1 an d\'expérience');
            }
            
            // Compétences
            if (competences > 90) {
                competencesDetails.push('Expert technique', 'Maîtrise avancée');
            } else if (competences > 80) {
                competencesDetails.push('Compétences solides', 'Bon niveau technique');
            } else if (competences > 70) {
                competencesDetails.push('Compétences de base', 'Niveau intermédiaire');
            } else {
                competencesDetails.push('Compétences limitées', 'Niveau débutant');
            }
            
            // Langues
            if (langues > 85) {
                languesDetails.push('Multilingue', 'Français, Anglais, Arabe');
            } else if (langues > 75) {
                languesDetails.push('Bilingue', 'Français, Anglais');
            } else if (langues > 65) {
                languesDetails.push('Français courant', 'Anglais basique');
            } else {
                languesDetails.push('Français uniquement', 'Langues limitées');
            }
            
            return {
                formationMatch: formationDetails,
                experienceMatch: experienceDetails,
                competencesMatch: competencesDetails,
                languesMatch: languesDetails
            };
        }

        // Fonction pour générer des recommandations intelligentes
        function generateRecommendations(totalScore, jobOffer, formation, experience, competences, langues) {
            const recommendations = [];
            
            // Recommandations basées sur le score total
            if (totalScore > 90) {
                recommendations.push('Excellent candidat - Profil idéal');
                recommendations.push('Recommandé pour un entretien immédiat');
            } else if (totalScore > 80) {
                recommendations.push('Très bon profil - Candidat prometteur');
                recommendations.push('Recommandé pour un entretien');
            } else if (totalScore > 70) {
                recommendations.push('Bon profil - Potentiel intéressant');
                recommendations.push('À considérer pour un entretien');
            } else {
                recommendations.push('Profil correct - Nécessite évaluation');
                recommendations.push('Formation complémentaire recommandée');
            }
            
            // Recommandations basées sur l'offre d'emploi
            if (jobOffer.title && jobOffer.title.toLowerCase().includes('data')) {
                if (competences > 85) {
                    recommendations.push('Excellentes compétences en analyse de données');
                }
                if (formation > 80) {
                    recommendations.push('Formation solide en sciences des données');
                }
            }
            
            // Recommandations basées sur les scores individuels
            if (formation > 90) {
                recommendations.push('Formation exceptionnelle');
            }
            if (experience > 85) {
                recommendations.push('Expérience très pertinente');
            }
            if (competences > 90) {
                recommendations.push('Compétences techniques excellentes');
            }
            if (langues > 85) {
                recommendations.push('Maîtrise linguistique remarquable');
            }
            
            return recommendations.slice(0, 3); // Limiter à 3 recommandations
        }

        // Fonction pour terminer l'analyse et retourner au dashboard
        function finishAnalysis() {
            console.log('=== TERMINAISON DE L\'ANALYSE ===');
            
            // Vérifier que nous avons des résultats d'analyse
            if (!window.analysisResults || window.analysisResults.length === 0) {
                console.error('Aucun résultat d\'analyse trouvé');
                alert('Erreur: Aucun résultat d\'analyse trouvé. Veuillez relancer l\'analyse.');
                return;
            }
            
            console.log('Résultats d\'analyse trouvés:', window.analysisResults.length, 'CVs');
            
            try {
                // Créer un objet d'analyse complet
                const analysisData = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    jobOffer: getJobOfferData(),
                    weights: getWeightsData(),
                    results: window.analysisResults,
                    totalCVs: window.analysisResults.length,
                    averageScore: calculateAverageScore(window.analysisResults),
                    bestScore: Math.max(...window.analysisResults.map(r => r.totalScore)),
                    worstScore: Math.min(...window.analysisResults.map(r => r.totalScore))
                };
                
                console.log('Données d\'analyse créées:', analysisData);
                
                // Sauvegarder la dernière analyse
                localStorage.setItem('lastAnalysisResults', JSON.stringify(window.analysisResults));
                localStorage.setItem('analysisCompleted', 'true');
                localStorage.setItem('analysisDate', new Date().toISOString());
                
                // Ajouter à l'historique des analyses
                saveAnalysisToHistory(analysisData);
                console.log('Analyse ajoutée à l\'historique');
                
                // Mettre à jour les statistiques du dashboard
                updateDashboardStats(analysisData);
                console.log('Statistiques du dashboard mises à jour');
                
                // Forcer la mise à jour du dashboard
                localStorage.setItem('dashboardNeedsUpdate', 'true');
                localStorage.setItem('lastAnalysisId', analysisData.id);
                localStorage.setItem('forceDashboardRefresh', 'true');
                
                console.log('Marqueurs de mise à jour du dashboard définis');
                
                // Afficher un message de confirmation
                alert('Analyse terminée avec succès ! Retour au dashboard...');
                
                // Rediriger vers le dashboard avec un paramètre pour forcer le refresh
                setTimeout(() => {
                    window.location.href = '/dashboard?refresh=' + Date.now() + '&analysis=' + analysisData.id;
                }, 1000);
                
                console.log('=== ANALYSE TERMINÉE AVEC SUCCÈS ===');
                
            } catch (error) {
                console.error('Erreur lors de la terminaison de l\'analyse:', error);
                alert('Erreur lors de la sauvegarde de l\'analyse. Veuillez réessayer.');
            }
        }

        // Fonction pour sauvegarder une analyse dans l'historique
        function saveAnalysisToHistory(analysisData) {
            let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
            
            // Ajouter la nouvelle analyse au début de l'historique
            analysisHistory.unshift(analysisData);
            
            // Garder seulement les 50 dernières analyses
            if (analysisHistory.length > 50) {
                analysisHistory = analysisHistory.slice(0, 50);
            }
            
            localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
            console.log('Analyse ajoutée à l\'historique:', analysisData.id);
        }

        // Fonction pour calculer le score moyen
        function calculateAverageScore(results) {
            if (!results || results.length === 0) return 0;
            const total = results.reduce((sum, result) => sum + result.totalScore, 0);
            return Math.round(total / results.length);
        }

        // Fonction pour mettre à jour les statistiques du dashboard
        function updateDashboardStats(analysisData) {
            // Récupérer les statistiques actuelles
            let dashboardStats = JSON.parse(localStorage.getItem('dashboardStats') || '{}');
            
            // Mettre à jour les compteurs
            dashboardStats.totalAnalyses = (dashboardStats.totalAnalyses || 0) + 1;
            dashboardStats.totalCVs = (dashboardStats.totalCVs || 0) + analysisData.totalCVs;
            
            // Calculer le score moyen global
            const allScores = getAllAnalysisScores();
            dashboardStats.averageScore = allScores.length > 0 ? 
                Math.round(allScores.reduce((sum, score) => sum + score, 0) / allScores.length) : 0;
            
            // Calculer le taux de réussite (CVs avec score > 70%)
            const successfulCVs = allScores.filter(score => score > 70).length;
            dashboardStats.successRate = allScores.length > 0 ? 
                Math.round((successfulCVs / allScores.length) * 100) : 0;
            
            // Statistiques de la semaine
            const weekStats = getWeekStats();
            dashboardStats.weekAnalyses = weekStats.analyses;
            dashboardStats.weekCVs = weekStats.cvs;
            dashboardStats.weekScoreChange = weekStats.scoreChange;
            dashboardStats.weekSuccessChange = weekStats.successChange;
            
            // Sauvegarder les statistiques
            localStorage.setItem('dashboardStats', JSON.stringify(dashboardStats));
            console.log('Statistiques du dashboard mises à jour:', dashboardStats);
        }

        // Fonction pour récupérer tous les scores de toutes les analyses
        function getAllAnalysisScores() {
            const analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
            const allScores = [];
            
            analysisHistory.forEach(analysis => {
                if (analysis.results) {
                    analysis.results.forEach(result => {
                        allScores.push(result.totalScore);
                    });
                }
            });
            
            return allScores;
        }

        // Fonction pour calculer les statistiques de la semaine
        function getWeekStats() {
            const analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const weekAnalyses = analysisHistory.filter(analysis => 
                new Date(analysis.timestamp) >= oneWeekAgo
            );
            
            const previousWeekAnalyses = analysisHistory.filter(analysis => {
                const analysisDate = new Date(analysis.timestamp);
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                return analysisDate >= twoWeeksAgo && analysisDate < oneWeekAgo;
            });
            
            const weekCVs = weekAnalyses.reduce((sum, analysis) => sum + analysis.totalCVs, 0);
            const previousWeekCVs = previousWeekAnalyses.reduce((sum, analysis) => sum + analysis.totalCVs, 0);
            
            const weekScores = [];
            weekAnalyses.forEach(analysis => {
                if (analysis.results) {
                    analysis.results.forEach(result => weekScores.push(result.totalScore));
                }
            });
            
            const previousWeekScores = [];
            previousWeekAnalyses.forEach(analysis => {
                if (analysis.results) {
                    analysis.results.forEach(result => previousWeekScores.push(result.totalScore));
                }
            });
            
            const weekAvgScore = weekScores.length > 0 ? 
                weekScores.reduce((sum, score) => sum + score, 0) / weekScores.length : 0;
            const previousWeekAvgScore = previousWeekScores.length > 0 ? 
                previousWeekScores.reduce((sum, score) => sum + score, 0) / previousWeekScores.length : 0;
            
            const weekSuccessRate = weekScores.length > 0 ? 
                (weekScores.filter(score => score > 70).length / weekScores.length) * 100 : 0;
            const previousWeekSuccessRate = previousWeekScores.length > 0 ? 
                (previousWeekScores.filter(score => score > 70).length / previousWeekScores.length) * 100 : 0;
            
            return {
                analyses: weekAnalyses.length,
                cvs: weekCVs,
                scoreChange: Math.round(weekAvgScore - previousWeekAvgScore),
                successChange: Math.round(weekSuccessRate - previousWeekSuccessRate)
            };
        }

        // Fonction pour afficher un CV avec animation dynamique
        function viewCV(fileName, index) {
            console.log('Affichage du CV:', fileName, 'Index:', index);
            
            // Récupérer les données du candidat
            const results = window.analysisResults || [];
            const candidate = results[index];
            
            if (!candidate) {
                console.error('Candidat non trouvé pour l\'index:', index);
                return;
            }
            
            // Créer une modal pour afficher le CV
            const modal = document.createElement('div');
            modal.className = 'cv-modal';
            modal.innerHTML = `
                <div class="modal-content cv-viewer">
                    <div class="modal-header">
                        <div class="candidate-info">
                            <h2><i class="fas fa-file-pdf"></i> ${fileName}</h2>
                            <p class="candidate-name">${candidate.name}</p>
                            <div class="candidate-score">
                                <span class="score-badge">Score: ${candidate.totalScore}%</span>
                                <span class="rank-badge">#${index + 1}</span>
                            </div>
                        </div>
                        <button class="close-btn" onclick="closeCVModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="cv-content">
                            <div class="cv-animation-container">
                                <div class="cv-loading">
                                    <div class="loading-spinner"></div>
                                    <p>Chargement du CV...</p>
                                </div>
                                <div class="cv-preview" style="display: none;">
                                    <div class="cv-document">
                                        <div class="cv-page">
                                            <div class="cv-header-doc">
                                                <div class="candidate-photo-doc">
                                                    <i class="fas fa-user-circle"></i>
                                                </div>
                                                <div class="candidate-info-doc">
                                                    <h1>${candidate.name}</h1>
                                                    <p class="candidate-title-doc">Candidat pour le poste</p>
                                                    <div class="contact-info">
                                                        <p><i class="fas fa-envelope"></i> ${candidate.name.toLowerCase().replace(' ', '.')}@email.com</p>
                                                        <p><i class="fas fa-phone"></i> +212 6XX XXX XXX</p>
                                                        <p><i class="fas fa-map-marker-alt"></i> Casablanca, Maroc</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="cv-section-doc">
                                                <h2><i class="fas fa-graduation-cap"></i> Formation</h2>
                                                <div class="section-content-doc">
                                                    ${candidate.extractedData && candidate.extractedData.education ? 
                                                        candidate.extractedData.education.map(edu => `
                                                            <div class="formation-item">
                                                                <h3>${edu.name}</h3>
                                                                <p class="institution">${edu.institution}</p>
                                                                <p class="period">${edu.year}</p>
                                                                <p class="description">Moyenne: ${edu.gpa}</p>
                                                            </div>
                                                        `).join('') :
                                                        `<div class="formation-item">
                                                            <h3>Master en Informatique</h3>
                                                            <p class="institution">Université Hassan II - Casablanca</p>
                                                            <p class="period">2020 - 2022</p>
                                                            <p class="description">Spécialisation en Data Science</p>
                                                        </div>`
                                                    }
                                                </div>
                                            </div>
                                            
                                            <div class="cv-section-doc">
                                                <h2><i class="fas fa-briefcase"></i> Expérience Professionnelle</h2>
                                                <div class="section-content-doc">
                                                    ${candidate.extractedData && candidate.extractedData.experience ? 
                                                        candidate.extractedData.experience.map(exp => `
                                                            <div class="experience-item">
                                                                <h3>${exp.title}</h3>
                                                                <p class="company">${exp.company}</p>
                                                                <p class="period">${exp.duration}</p>
                                                                <p class="description">${exp.description}</p>
                                                                <ul class="achievements">
                                                                    ${exp.achievements.map(achievement => `<li>${achievement}</li>`).join('')}
                                                                </ul>
                                                            </div>
                                                        `).join('') :
                                                        `<div class="experience-item">
                                                            <h3>Développeur Data Scientist</h3>
                                                            <p class="company">TechCorp Maroc</p>
                                                            <p class="period">2022 - Présent</p>
                                                            <ul class="achievements">
                                                                <li>Développement de modèles de machine learning</li>
                                                                <li>Analyse de données et création de dashboards</li>
                                                            </ul>
                                                        </div>`
                                                    }
                                                </div>
                                            </div>
                                            
                                            <div class="cv-section-doc">
                                                <h2><i class="fas fa-tools"></i> Compétences Techniques</h2>
                                                <div class="section-content-doc">
                                                    ${candidate.extractedData && candidate.extractedData.skills ? 
                                                        Object.keys(candidate.extractedData.skills).map(category => `
                                                            <div class="skill-category">
                                                                <h4>${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                                                                <div class="skill-tags">
                                                                    ${candidate.extractedData.skills[category].map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                                                                </div>
                                                            </div>
                                                        `).join('') :
                                                        `<div class="skill-category">
                                                            <h4>Langages de Programmation</h4>
                                                            <div class="skill-tags">
                                                                <span class="skill-tag">Python</span>
                                                                <span class="skill-tag">JavaScript</span>
                                                                <span class="skill-tag">SQL</span>
                                                            </div>
                                                        </div>`
                                                    }
                                                </div>
                                            </div>
                                            
                                            <div class="cv-section-doc">
                                                <h2><i class="fas fa-language"></i> Langues</h2>
                                                <div class="section-content-doc">
                                                    <div class="languages-list">
                                                        ${candidate.extractedData && candidate.extractedData.languages ? 
                                                            candidate.extractedData.languages.map(lang => `
                                                                <div class="language-item">
                                                                    <span class="language">${lang.name}</span>
                                                                    <span class="level">${lang.level}</span>
                                                                </div>
                                                            `).join('') :
                                                            `<div class="language-item">
                                                                <span class="language">Français</span>
                                                                <span class="level">Natif</span>
                                                            </div>
                                                            <div class="language-item">
                                                                <span class="language">Anglais</span>
                                                                <span class="level">Courant</span>
                                                            </div>`
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeCVModal()">
                            <i class="fas fa-times"></i> Fermer
                        </button>
                        <button class="btn btn-primary">
                            <i class="fas fa-download"></i> Télécharger CV
                        </button>
                        <button class="btn btn-info">
                            <i class="fas fa-print"></i> Imprimer
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animation d'ouverture
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // Animation de chargement puis affichage du contenu
            setTimeout(() => {
                const loading = modal.querySelector('.cv-loading');
                const preview = modal.querySelector('.cv-preview');
                
                if (loading && preview) {
                    loading.style.display = 'none';
                    preview.style.display = 'block';
                    
                    // Animation d'apparition du document
                    preview.style.opacity = '0';
                    preview.style.transform = 'scale(0.9)';
                    
                    setTimeout(() => {
                        preview.style.transition = 'all 0.5s ease-out';
                        preview.style.opacity = '1';
                        preview.style.transform = 'scale(1)';
                    }, 100);
                }
            }, 1500);
        }

        // Fonction pour fermer la modal
        function closeCVModal() {
            const modal = document.querySelector('.cv-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Ajouter les event listeners pour les sliders
        document.addEventListener('DOMContentLoaded', function() {
            const sliders = document.querySelectorAll('.weight-slider');
            sliders.forEach(slider => {
                slider.addEventListener('input', function() {
                    const value = this.value;
                    const valueSpan = this.parentElement.querySelector('.weight-value');
                    valueSpan.textContent = value + '%';
                    updateWeightTotal();
                });
            });
        });

        // Fonction de test pour forcer l'affichage des résultats
        function testResultsDisplay() {
            console.log('Test d\'affichage des résultats...');
            const testResults = performFallbackAnalysis({}, {});
            displayResults(testResults);
        }

        // Fonction pour charger des résultats de test
        function loadTestResults() {
            console.log('=== CHARGEMENT DES RÉSULTATS DE TEST ===');
            
            // Données de test
            const testResults = [
                {
                    candidateId: 'candidate_1',
                    fileName: 'cv_Adam.pdf',
                    name: 'Adam Smith',
                    totalScore: 86,
                    scores: {
                        formation: 85,
                        experience: 78,
                        competencesTechniques: 92,
                        langues: 88
                    },
                    matchDetails: {
                        formationMatch: ['Master Data Science', 'Université de Paris'],
                        experienceMatch: ['5 ans d\'expérience', 'Développeur Senior'],
                        competencesMatch: ['Python', 'Machine Learning', 'AWS'],
                        languesMatch: ['Français (natif)', 'Anglais (courant)']
                    },
                    recommendations: ['Profil très prometteur', 'Excellent candidat pour le poste']
                },
                {
                    candidateId: 'candidate_2',
                    fileName: 'cv_Hafsa.pdf',
                    name: 'Hafsa El Ghazouani',
                    totalScore: 81,
                    scores: {
                        formation: 80,
                        experience: 70,
                        competencesTechniques: 85,
                        langues: 90
                    },
                    matchDetails: {
                        formationMatch: ['Master Statistiques', 'Université Hassan II'],
                        experienceMatch: ['4 ans d\'expérience', 'Analyste de Données'],
                        competencesMatch: ['R', 'Python', 'SQL', 'Tableau'],
                        languesMatch: ['Français (natif)', 'Anglais (courant)', 'Arabe (natif)']
                    },
                    recommendations: ['Profil très prometteur', 'Excellentes compétences linguistiques']
                },
                {
                    candidateId: 'candidate_3',
                    fileName: 'cv_Ali.pdf',
                    name: 'Ali Benali',
                    totalScore: 73,
                    scores: {
                        formation: 75,
                        experience: 65,
                        competencesTechniques: 78,
                        langues: 72
                    },
                    matchDetails: {
                        formationMatch: ['Licence Informatique', 'École Polytechnique'],
                        experienceMatch: ['3 ans d\'expérience', 'Développeur Full Stack'],
                        competencesMatch: ['Java', 'Spring Boot', 'Angular'],
                        languesMatch: ['Français (natif)', 'Anglais (avancé)']
                    },
                    recommendations: ['Bon candidat avec potentiel', 'Compétences techniques solides']
                }
            ];

            // Afficher les résultats
            displayTestResults(testResults);
            
            console.log('Résultats de test chargés avec succès!');
        }

        // Fonction pour afficher les résultats de test
        function displayTestResults(results) {
            console.log('Affichage des résultats de test:', results);
            
            // Mettre à jour les statistiques globales
            const scores = results.map(r => r.totalScore);
            const avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            const maxScore = Math.max(...scores);
            
            document.getElementById('averageScore').textContent = avgScore + '%';
            document.getElementById('bestScore').textContent = maxScore + '%';
            
            // Vider et remplir la liste des résultats
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            // Trier par score décroissant
            results.sort((a, b) => b.totalScore - a.totalScore);
            
            results.forEach((result, index) => {
                const rank = index + 1;
                let gradientColor, shadowColor;
                
                if (rank === 1) {
                    gradientColor = 'linear-gradient(135deg, #22c55e, #16a34a)';
                    shadowColor = 'rgba(34, 197, 94, 0.3)';
                } else if (rank === 2) {
                    gradientColor = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                    shadowColor = 'rgba(59, 130, 246, 0.3)';
                } else {
                    gradientColor = 'linear-gradient(135deg, #f59e0b, #d97706)';
                    shadowColor = 'rgba(245, 158, 11, 0.3)';
                }
                
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.style.cssText = `
                    background: ${gradientColor};
                    color: white;
                    margin-bottom: 20px;
                    padding: 25px;
                    border-radius: 15px;
                    box-shadow: 0 8px 25px ${shadowColor};
                `;
                
                resultItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <span style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-weight: bold; margin-right: 15px;">#${rank}</span>
                                <h3 style="margin: 0; font-size: 1.4rem;"><i class="fas fa-user"></i> ${result.name}</h3>
                            </div>
                            <p style="margin: 5px 0; opacity: 0.9;">${result.fileName}</p>
                            <div style="display: flex; gap: 20px; margin-top: 15px; font-size: 0.9rem;">
                                <span><strong>Formation:</strong> ${result.scores.formation}%</span>
                                <span><strong>Expérience:</strong> ${result.scores.experience}%</span>
                                <span><strong>Compétences:</strong> ${result.scores.competencesTechniques}%</span>
                                <span><strong>Langues:</strong> ${result.scores.langues}%</span>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 5px;">${result.totalScore}%</div>
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 8px;" onclick="viewCV('${result.fileName}', ${index})">
                                <i class="fas fa-eye"></i> Voir CV
                            </button>
                        </div>
                    </div>
                `;
                
                resultsList.appendChild(resultItem);
            });
        }

        // Initialiser
        detectUser();
        updateProgress();
        
        // Forcer l'affichage de l'étape 5 si nécessaire
        setTimeout(() => {
            if (currentStep === 5) {
                const step5Element = document.getElementById('step5');
                if (step5Element) {
                    step5Element.style.display = 'block';
                    step5Element.style.visibility = 'visible';
                    step5Element.style.opacity = '1';
                    console.log('Initialisation: Étape 5 forcée à s\'afficher');
                }
            }
        }, 1000);
        

        // Fonction pour afficher le statut de chargement des CVs
        function showUploadStatus() {
            console.log('Affichage du statut de chargement...');
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) {
                uploadStatus.style.display = 'block';
                simulateUploadProgress();
            }
        }

        // Fonction pour simuler la progression du chargement
        function simulateUploadProgress() {
            const progressFill = document.getElementById('uploadProgress');
            const uploadText = document.getElementById('uploadText');
            
            if (!progressFill || !uploadText) return;

            let progress = 0;
            const messages = [
                'Préparation des fichiers...',
                'Analyse des formats...',
                'Extraction du contenu...',
                'Validation des données...',
                'Finalisation...'
            ];

            const interval = setInterval(() => {
                progress += 20;
                progressFill.style.width = progress + '%';
                
                if (progress <= 100) {
                    const messageIndex = Math.floor((progress - 1) / 20);
                    if (messageIndex < messages.length) {
                        uploadText.textContent = messages[messageIndex];
                    }
                }

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        hideUploadStatus();
                        showUploadedFiles();
                    }, 1000);
                }
            }, 500);
        }

        // Fonction pour masquer le statut de chargement
        function hideUploadStatus() {
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) {
                uploadStatus.style.display = 'none';
            }
        }

        // Fonction pour afficher les fichiers uploadés
        function showUploadedFiles() {
            console.log('Affichage des fichiers uploadés:', importedCVs);
            const uploadedFiles = document.getElementById('uploadedFiles');
            const fileList = document.getElementById('fileList');
            
            if (uploadedFiles) {
                uploadedFiles.style.display = 'block';
            }
            
            if (fileList && importedCVs.length > 0) {
                // Vider complètement la liste pour éviter les doublons
                fileList.innerHTML = '';
                console.log('Liste vidée, ajout de', importedCVs.length, 'fichiers');
                
                importedCVs.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px;
                        background: rgba(102, 126, 234, 0.05);
                        border-radius: 10px;
                        margin-bottom: 10px;
                        border: 1px solid rgba(102, 126, 234, 0.1);
                    `;
                    
                    fileItem.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-file-pdf" style="color: #e74c3c; font-size: 1.5rem; margin-right: 15px;"></i>
                            <div>
                                <h4 style="margin: 0; color: #333;">${file.name}</h4>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">${file.size}</p>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-secondary" style="margin-right: 10px; padding: 8px 12px; font-size: 0.9rem;">
                                <i class="fas fa-eye"></i> Voir
                            </button>
                            <button class="btn btn-danger" style="padding: 8px 12px; font-size: 0.9rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    fileList.appendChild(fileItem);
                });
            }
        }

        // Fonction pour charger des fichiers de démonstration (optionnel)
        function loadDemoFiles() {
            console.log('Chargement des fichiers de démonstration...');
            showUploadStatus();
            // Après le chargement, ajouter les fichiers de démonstration
            setTimeout(() => {
                addDemoFiles();
            }, 3000);
        }

        // Fonction pour charger 7 CVs
        function load7CVs() {
            console.log('Chargement de 7 CVs...');
            showUploadStatus();
            // Après le chargement, ajouter 7 CVs
            setTimeout(() => {
                add7CVs();
            }, 3000);
        }

        // Fonction principale pour importer des CVs
        function importCVs() {
            console.log('Importation des CVs...');
            // Déclencher le sélecteur de fichiers
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        // Gestionnaire d'événement pour les fichiers sélectionnés
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        console.log('Fichiers sélectionnés:', files.length);
                        processSelectedFiles(files);
                    }
                });
            }
        });

        // Fonction pour extraire le texte d'un PDF
        async function extractTextFromPDF(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n';
                        }
                        
                        resolve(fullText);
                    } catch (error) {
                        console.error('Erreur lors de l\'extraction PDF:', error);
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // Fonction pour analyser le texte extrait et extraire les données
        function analyzeExtractedText(text, fileName) {
            console.log('Analyse du texte extrait pour:', fileName);
            console.log('Texte extrait:', text.substring(0, 500) + '...');
            
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            // Extraire le nom (généralement dans les premières lignes)
            const name = extractName(lines);
            
            // Extraire les informations personnelles
            const personalInfo = extractPersonalInfo(text, name);
            
            // Extraire la formation
            const education = extractEducation(text);
            
            // Extraire l'expérience
            const experience = extractExperience(text);
            
            // Extraire les compétences
            const skills = extractSkills(text);
            
            // Extraire les langues
            const languages = extractLanguages(text);
            
            return {
                fileName: fileName,
                originalText: text,
                personalInfo: personalInfo,
                education: education,
                experience: experience,
                skills: skills,
                languages: languages
            };
        }

        // Fonction pour extraire le nom
        function extractName(lines) {
            // Chercher dans les premières lignes un nom (majuscules, pas de chiffres)
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i];
                if (line.length > 2 && line.length < 50 && 
                    /^[A-ZÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞß][a-zàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ\s\-']+$/.test(line)) {
                    return line;
                }
            }
            return "Candidat";
        }

        // Fonction pour extraire les informations personnelles
        function extractPersonalInfo(text, name) {
            const emailMatch = text.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            const phoneMatch = text.match(/(\+212|0)[\s\-]?[5-7][\s\-]?[0-9]{2}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}/);
            const linkedinMatch = text.match(/linkedin\.com\/in\/[a-zA-Z0-9\-]+/i);
            
            return {
                name: name,
                email: emailMatch ? emailMatch[1] : `${name.toLowerCase().replace(/\s+/g, '.')}@email.com`,
                phone: phoneMatch ? phoneMatch[0] : "Non spécifié",
                address: "Maroc", // Par défaut
                linkedin: linkedinMatch ? linkedinMatch[0] : ""
            };
        }

        // Fonction pour extraire la formation
        function extractEducation(text) {
            const education = [];
            const educationKeywords = ['formation', 'éducation', 'diplôme', 'master', 'licence', 'bac', 'université', 'école', 'institut'];
            
            const lines = text.split('\n');
            let inEducationSection = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase();
                
                // Détecter le début de la section formation
                if (educationKeywords.some(keyword => line.includes(keyword))) {
                    inEducationSection = true;
                    continue;
                }
                
                if (inEducationSection) {
                    // Chercher des diplômes
                    if (line.includes('master') || line.includes('licence') || line.includes('bac')) {
                        const degree = lines[i];
                        const institution = lines[i + 1] || "Institution non spécifiée";
                        const year = extractYear(lines[i + 2] || lines[i + 1] || "");
                        
                        education.push({
                            name: degree,
                            institution: institution,
                            year: year,
                            gpa: "Non spécifié"
                        });
                    }
                }
                
                // Arrêter si on trouve une autre section
                if (line.includes('expérience') || line.includes('compétences') || line.includes('langues')) {
                    inEducationSection = false;
                }
            }
            
            return education.length > 0 ? education : [{
                name: "Formation non spécifiée",
                institution: "Institution non spécifiée",
                year: "Non spécifié",
                gpa: "Non spécifié"
            }];
        }

        // Fonction pour extraire l'expérience
        function extractExperience(text) {
            const experience = [];
            const experienceKeywords = ['expérience', 'emploi', 'travail', 'poste', 'fonction'];
            
            const lines = text.split('\n');
            let inExperienceSection = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase();
                
                // Détecter le début de la section expérience
                if (experienceKeywords.some(keyword => line.includes(keyword))) {
                    inExperienceSection = true;
                    continue;
                }
                
                if (inExperienceSection) {
                    // Chercher des postes (lignes avec des mots-clés de postes)
                    const jobKeywords = ['développeur', 'ingénieur', 'analyste', 'consultant', 'manager', 'directeur', 'chef', 'responsable'];
                    if (jobKeywords.some(keyword => line.includes(keyword))) {
                        const title = lines[i];
                        const company = lines[i + 1] || "Entreprise non spécifiée";
                        const duration = extractYear(lines[i + 2] || lines[i + 1] || "");
                        
                        experience.push({
                            title: title,
                            company: company,
                            duration: duration,
                            description: "Description non spécifiée",
                            achievements: ["Réalisations non spécifiées"]
                        });
                    }
                }
                
                // Arrêter si on trouve une autre section
                if (line.includes('formation') || line.includes('compétences') || line.includes('langues')) {
                    inExperienceSection = false;
                }
            }
            
            return experience.length > 0 ? experience : [{
                title: "Expérience non spécifiée",
                company: "Entreprise non spécifiée",
                duration: "Non spécifié",
                description: "Description non spécifiée",
                achievements: ["Réalisations non spécifiées"]
            }];
        }

        // Fonction pour extraire les compétences
        function extractSkills(text) {
            const skills = {
                programming: [],
                frameworks: [],
                databases: [],
                tools: [],
                ml: []
            };
            
            // Mots-clés de compétences
            const skillKeywords = {
                programming: ['python', 'java', 'javascript', 'c++', 'c#', 'php', 'ruby', 'go', 'rust', 'sql', 'r'],
                frameworks: ['react', 'angular', 'vue', 'django', 'flask', 'spring', 'node.js', 'express', 'laravel'],
                databases: ['mysql', 'postgresql', 'mongodb', 'oracle', 'sqlite', 'redis', 'elasticsearch'],
                tools: ['git', 'docker', 'kubernetes', 'jenkins', 'aws', 'azure', 'gcp', 'tableau', 'power bi'],
                ml: ['tensorflow', 'pytorch', 'scikit-learn', 'pandas', 'numpy', 'keras', 'opencv', 'machine learning', 'deep learning']
            };
            
            const textLower = text.toLowerCase();
            
            Object.keys(skillKeywords).forEach(category => {
                skillKeywords[category].forEach(skill => {
                    if (textLower.includes(skill)) {
                        skills[category].push(skill.charAt(0).toUpperCase() + skill.slice(1));
                    }
                });
            });
            
            return skills;
        }

        // Fonction pour extraire les langues
        function extractLanguages(text) {
            const languages = [];
            const languageKeywords = ['français', 'anglais', 'arabe', 'espagnol', 'allemand', 'italien', 'portugais'];
            
            const textLower = text.toLowerCase();
            
            languageKeywords.forEach(lang => {
                if (textLower.includes(lang)) {
                    languages.push({
                        name: lang.charAt(0).toUpperCase() + lang.slice(1),
                        level: "Non spécifié",
                        proficiency: 70
                    });
                }
            });
            
            return languages.length > 0 ? languages : [{
                name: "Français",
                level: "Natif",
                proficiency: 100
            }];
        }

        // Fonction pour extraire les années
        function extractYear(text) {
            const yearMatch = text.match(/(19|20)\d{2}/);
            return yearMatch ? yearMatch[0] : "Non spécifié";
        }

        // Fonction pour générer des données de formation réalistes
        function generateEducationData() {
            const degrees = [
                { name: "Master en Informatique", institution: "Université Hassan II - Casablanca", year: "2020-2022", gpa: "16.5/20" },
                { name: "Master en Data Science", institution: "École Nationale Supérieure d'Informatique", year: "2019-2021", gpa: "15.8/20" },
                { name: "Licence en Informatique", institution: "Université Mohammed V - Rabat", year: "2016-2019", gpa: "14.2/20" },
                { name: "Master en Intelligence Artificielle", institution: "École Mohammadia d'Ingénieurs", year: "2020-2022", gpa: "17.1/20" },
                { name: "Licence en Génie Logiciel", institution: "Université Ibn Zohr - Agadir", year: "2017-2020", gpa: "15.5/20" }
            ];
            
            return [degrees[Math.floor(Math.random() * degrees.length)]];
        }

        // Fonction pour générer des données d'expérience réalistes
        function generateExperienceData() {
            const experiences = [
                {
                    title: "Data Scientist Senior",
                    company: "TechCorp Maroc",
                    duration: "2022 - Présent",
                    description: "Développement de modèles de machine learning pour l'analyse prédictive",
                    achievements: [
                        "Amélioration de 30% de la précision des modèles prédictifs",
                        "Mise en place d'un pipeline de données automatisé",
                        "Formation de 5 développeurs juniors"
                    ]
                },
                {
                    title: "Développeur Full Stack",
                    company: "StartupTech",
                    duration: "2020 - 2022",
                    description: "Développement d'applications web et mobile",
                    achievements: [
                        "Développement de 3 applications web complètes",
                        "Intégration d'APIs REST et GraphQL",
                        "Optimisation des performances de 40%"
                    ]
                },
                {
                    title: "Stagiaire Développeur",
                    company: "Digital Agency",
                    duration: "Été 2019",
                    description: "Participation au développement de projets web",
                    achievements: [
                        "Développement de composants React",
                        "Tests unitaires et d'intégration",
                        "Documentation technique"
                    ]
                }
            ];
            
            // Retourner 1-3 expériences aléatoires
            const numExperiences = Math.floor(Math.random() * 3) + 1;
            return experiences.slice(0, numExperiences);
        }

        // Fonction pour générer des compétences réalistes
        function generateSkillsData() {
            const allSkills = {
                programming: ["Python", "JavaScript", "Java", "C++", "R", "SQL", "TypeScript", "Go"],
                frameworks: ["React", "Vue.js", "Angular", "Django", "Flask", "Spring Boot", "Node.js", "Express"],
                databases: ["PostgreSQL", "MongoDB", "MySQL", "Redis", "Elasticsearch", "Oracle"],
                tools: ["Git", "Docker", "Kubernetes", "Jenkins", "AWS", "Azure", "Tableau", "Power BI"],
                ml: ["TensorFlow", "PyTorch", "Scikit-learn", "Pandas", "NumPy", "Keras", "OpenCV"]
            };
            
            const skills = {};
            Object.keys(allSkills).forEach(category => {
                const numSkills = Math.floor(Math.random() * 3) + 2; // 2-4 compétences par catégorie
                skills[category] = allSkills[category].sort(() => 0.5 - Math.random()).slice(0, numSkills);
            });
            
            return skills;
        }

        // Fonction pour générer des langues réalistes
        function generateLanguagesData() {
            const languages = [
                { name: "Français", level: "Natif", proficiency: 100 },
                { name: "Anglais", level: "Courant", proficiency: 85 },
                { name: "Arabe", level: "Natif", proficiency: 100 },
                { name: "Espagnol", level: "Intermédiaire", proficiency: 60 }
            ];
            
            // Retourner 2-4 langues
            const numLanguages = Math.floor(Math.random() * 3) + 2;
            return languages.slice(0, numLanguages);
        }

        // Fonction pour générer des certifications
        function generateCertificationsData() {
            const certifications = [
                "AWS Certified Solutions Architect",
                "Google Cloud Professional Data Engineer",
                "Microsoft Azure Data Scientist Associate",
                "Certified Scrum Master (CSM)",
                "Oracle Certified Java Developer",
                "Cisco Certified Network Associate (CCNA)"
            ];
            
            const numCerts = Math.floor(Math.random() * 3) + 1; // 1-3 certifications
            return certifications.sort(() => 0.5 - Math.random()).slice(0, numCerts);
        }

        // Fonction pour générer des projets
        function generateProjectsData() {
            const projects = [
                {
                    name: "Système de Recommandation E-commerce",
                    description: "Développement d'un système de recommandation basé sur l'IA",
                    technologies: ["Python", "TensorFlow", "PostgreSQL", "Docker"],
                    duration: "6 mois"
                },
                {
                    name: "Dashboard Analytics en Temps Réel",
                    description: "Création d'un dashboard pour l'analyse de données en temps réel",
                    technologies: ["React", "Node.js", "MongoDB", "WebSocket"],
                    duration: "4 mois"
                },
                {
                    name: "Application Mobile de Gestion",
                    description: "Développement d'une application mobile cross-platform",
                    technologies: ["React Native", "Firebase", "Redux"],
                    duration: "3 mois"
                }
            ];
            
            const numProjects = Math.floor(Math.random() * 3) + 1; // 1-3 projets
            return projects.sort(() => 0.5 - Math.random()).slice(0, numProjects);
        }

        // Fonction pour traiter les fichiers sélectionnés
        async function processSelectedFiles(files) {
            console.log('Traitement des fichiers sélectionnés...');
            
            // Afficher le statut de chargement
            showUploadStatus();
            
            try {
                const cvFiles = [];
                
                // Traiter chaque fichier
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log('Traitement du fichier:', file.name);
                    
                    // Mettre à jour le statut de chargement
                    const uploadText = document.getElementById('uploadText');
                    if (uploadText) {
                        uploadText.textContent = `Extraction des données de ${file.name}...`;
                    }
                    
                    const basicInfo = {
                        name: file.name,
                        size: (file.size / 1024).toFixed(1) + ' KB'
                    };
                    
                    try {
                        // Extraire le texte du PDF
                        const extractedText = await extractTextFromPDF(file);
                        console.log('Texte extrait pour', file.name, ':', extractedText.substring(0, 200) + '...');
                        
                        // Analyser le texte extrait
                        const extractedData = analyzeExtractedText(extractedText, file.name);
                        
                        cvFiles.push({
                            ...basicInfo,
                            extractedData: extractedData
                        });
                        
                    } catch (error) {
                        console.error('Erreur lors de l\'extraction de', file.name, ':', error);
                        
                        // Fallback si l'extraction échoue
                        const extractedData = {
                            fileName: file.name,
                            originalText: "Erreur d'extraction",
                            personalInfo: {
                                name: file.name.replace('.pdf', '').replace('.doc', '').replace('.docx', ''),
                                email: "Non spécifié",
                                phone: "Non spécifié",
                                address: "Non spécifié",
                                linkedin: ""
                            },
                            education: [{
                                name: "Formation non spécifiée",
                                institution: "Institution non spécifiée",
                                year: "Non spécifié",
                                gpa: "Non spécifié"
                            }],
                            experience: [{
                                title: "Expérience non spécifiée",
                                company: "Entreprise non spécifiée",
                                duration: "Non spécifié",
                                description: "Description non spécifiée",
                                achievements: ["Réalisations non spécifiées"]
                            }],
                            skills: {
                                programming: [],
                                frameworks: [],
                                databases: [],
                                tools: [],
                                ml: []
                            },
                            languages: [{
                                name: "Français",
                                level: "Natif",
                                proficiency: 100
                            }]
                        };
                        
                        cvFiles.push({
                            ...basicInfo,
                            extractedData: extractedData
                        });
                    }
                    
                    // Mettre à jour la barre de progression
                    const progress = ((i + 1) / files.length) * 100;
                    const progressBar = document.getElementById('uploadProgress');
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                }

                // Stocker les CVs importés avec leurs données extraites
                importedCVs = cvFiles;
                console.log('CVs traités avec données extraites:', importedCVs);

                // Masquer le statut de chargement et afficher les fichiers
                hideUploadStatus();
                showUploadedFiles();
                updateVerificationPage();
                
            } catch (error) {
                console.error('Erreur lors du traitement des fichiers:', error);
                hideUploadStatus();
                alert('Erreur lors du traitement des fichiers. Veuillez réessayer.');
            }
        }

        // Fonction pour ajouter des fichiers de démonstration
        function addDemoFiles() {
            const fileList = document.getElementById('fileList');
            if (!fileList) return;

            const demoFiles = [
                { name: 'cv_candidat_1.pdf', size: '245.3 KB' },
                { name: 'cv_candidat_2.pdf', size: '189.7 KB' },
                { name: 'cv_candidat_3.pdf', size: '312.1 KB' }
            ];

            // Stocker les CVs importés
            importedCVs = demoFiles;

            fileList.innerHTML = '';
            demoFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px;
                    background: rgba(102, 126, 234, 0.05);
                    border-radius: 10px;
                    margin-bottom: 10px;
                    border: 1px solid rgba(102, 126, 234, 0.1);
                `;
                
                fileItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-file-pdf" style="color: #e74c3c; font-size: 1.5rem; margin-right: 15px;"></i>
                        <div>
                            <h4 style="margin: 0; color: #333;">${file.name}</h4>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">${file.size}</p>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" style="margin-right: 10px; padding: 8px 12px; font-size: 0.9rem;">
                            <i class="fas fa-eye"></i> Voir
                        </button>
                        <button class="btn btn-danger" style="padding: 8px 12px; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });

            // Mettre à jour la page de vérification
            updateVerificationPage();
        }

        // Fonction pour ajouter 7 CVs
        function add7CVs() {
            const fileList = document.getElementById('fileList');
            if (!fileList) return;

            const sevenCVs = [
                { name: 'cv_Amine_Benali.pdf', size: '245.3 KB' },
                { name: 'cv_Fatima_Alami.pdf', size: '189.7 KB' },
                { name: 'cv_Youssef_Chraibi.pdf', size: '312.1 KB' },
                { name: 'cv_Aicha_Mansouri.pdf', size: '278.5 KB' },
                { name: 'cv_Omar_Tazi.pdf', size: '201.8 KB' },
                { name: 'cv_Khadija_Bennani.pdf', size: '334.2 KB' },
                { name: 'cv_Mehdi_Alaoui.pdf', size: '267.9 KB' }
            ];

            // Stocker les CVs importés
            importedCVs = sevenCVs;

            fileList.innerHTML = '';
            sevenCVs.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px;
                    background: rgba(102, 126, 234, 0.05);
                    border-radius: 10px;
                    margin-bottom: 10px;
                    border: 1px solid rgba(102, 126, 234, 0.1);
                `;
                
                fileItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-file-pdf" style="color: #e74c3c; font-size: 1.5rem; margin-right: 15px;"></i>
                        <div>
                            <h4 style="margin: 0; color: #333;">${file.name}</h4>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">${file.size}</p>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" style="margin-right: 10px; padding: 8px 12px; font-size: 0.9rem;">
                            <i class="fas fa-eye"></i> Voir
                        </button>
                        <button class="btn btn-danger" style="padding: 8px 12px; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });

            // Mettre à jour la page de vérification
            updateVerificationPage();
        }

        // Fonction pour mettre à jour la page de vérification avec les CVs importés
        function updateVerificationPage() {
            const cvCount = document.getElementById('cvCount');
            const cvList = document.getElementById('cvList');
            
            if (cvCount && cvList) {
                if (importedCVs.length > 0) {
                    cvCount.textContent = `${importedCVs.length} CVs sélectionnés`;
                    cvList.innerHTML = '';
                    
                    importedCVs.forEach((cv, index) => {
                        const li = document.createElement('li');
                        li.style.cssText = 'padding: 8px 0; color: #333; border-bottom: 1px solid rgba(0,0,0,0.1);';
                        li.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-file-pdf" style="color: #e74c3c; margin-right: 10px;"></i>
                                <span>${cv.name}</span>
                                <span style="margin-left: auto; font-size: 12px; color: #666;">${cv.size}</span>
                            </div>
                        `;
                        cvList.appendChild(li);
                    });
                } else {
                    cvCount.textContent = '0 CVs sélectionnés';
                    cvList.innerHTML = '<li style="padding: 10px; text-align: center; color: #999; font-style: italic;">Aucun CV importé</li>';
                }
            }
        }

        // Fonction pour traiter les fichiers
        function processFiles() {
            console.log('Traitement des fichiers...');
            showUploadStatus();
        }

        // Fonction pour effacer les fichiers
        function clearFiles() {
            const uploadedFiles = document.getElementById('uploadedFiles');
            const fileList = document.getElementById('fileList');
            
            if (uploadedFiles) uploadedFiles.style.display = 'none';
            if (fileList) fileList.innerHTML = '';
            
            console.log('Fichiers effacés');
        }

        // Les pages restent vierges jusqu'à ce que l'utilisateur les remplisse
</script>

</body>
</html>
